# task_cache_manager.py æ¨¡å—å®ç°å®ŒæˆæŠ¥å‘Š

## âœ… å®Œæˆæƒ…å†µ

**æ ¹æ®æ‚¨çš„è®¾è®¡è¦æ±‚ï¼Œå·²å®Œæˆ task_cache_manager.py æ¨¡å—çš„å®Œæ•´å®ç°ï¼**

---

## ğŸ“‹ å®ç°çš„åŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æ–¹æ³•å | çŠ¶æ€ | è¯´æ˜ |
|---------|--------|------|------|
| **è®¾ç½®ç¼“å­˜** | `set_cache()` | âœ… | å­˜å‚¨key-valueæ•°æ®ï¼Œå¸¦TTL |
| **è·å–ç¼“å­˜** | `get_cache()` | âœ… | è·å–ç¼“å­˜å€¼ï¼Œè‡ªåŠ¨æ£€æŸ¥è¿‡æœŸ |
| **æ£€æŸ¥ç¼“å­˜** | `has_cache()` | âœ… | æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœŸ |
| **æ¸…é™¤ç¼“å­˜** | `clear_cache()` | âœ… | æ¸…é™¤ç‰¹å®šç¼“å­˜ |
| **æ¸…é™¤è¿‡æœŸç¼“å­˜** | `clear_expired_cache()` | âœ… | è‡ªåŠ¨æ¸…ç†æ‰€æœ‰è¿‡æœŸæ¡ç›® |
| **åˆ›å»ºå¿«ç…§** | `snapshot_current_state()` | âœ… | å¤‡ä»½å½“å‰ç¼“å­˜çŠ¶æ€ |
| **æ¢å¤å¿«ç…§** | `restore_from_snapshot()` | âœ… | ä»å¿«ç…§æ¢å¤ç¼“å­˜çŠ¶æ€ |
| **æ¸…é™¤å¿«ç…§** | `clear_snapshot()` | âœ… | åˆ é™¤å¿«ç…§ |
| **æ¸…é™¤æ‰€æœ‰ç¼“å­˜** | `clear_all_cache()` | âœ… | æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ |
| **æ¸…é™¤æ‰€æœ‰å¿«ç…§** | `clear_all_snapshots()` | âœ… | æ¸…ç©ºæ‰€æœ‰å¿«ç…§ |
| **è·å–ç¼“å­˜ä¿¡æ¯** | `get_cache_info()` | âœ… | è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ |

---

## ğŸ“Š æ•°æ®ç»“æ„

### CacheEntryï¼ˆç¼“å­˜æ¡ç›®ï¼‰

```python
@dataclass
class CacheEntry:
    key: str                       # ç¼“å­˜é”®
    value: Any                     # ç¼“å­˜å€¼
    created_at: str                # åˆ›å»ºæ—¶é—´
    expires_at: str                # è¿‡æœŸæ—¶é—´
    access_count: int = 0          # è®¿é—®æ¬¡æ•°
    last_accessed: Optional[str]  # æœ€åè®¿é—®æ—¶é—´
```

### æ•°æ®ç»“æ„ç¤ºä¾‹

```python
{
    "plan_route.eta": {
        "key": "plan_route.eta",
        "value": "18åˆ†é’Ÿ",
        "created_at": "2025-10-30T15:00:00",
        "expires_at": "2025-10-30T15:10:00",
        "access_count": 3,
        "last_accessed": "2025-10-30T15:05:00"
    },
    "user_reply.confirm_hospital": {
        "key": "user_reply.confirm_hospital",
        "value": "è™¹å£åŒ»é™¢",
        "created_at": "2025-10-30T15:00:00",
        "expires_at": "2025-10-30T15:10:00",
        "access_count": 1,
        "last_accessed": "2025-10-30T15:00:00"
    }
}
```

---

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### é»˜è®¤è®¾ç½®

- **é»˜è®¤TTL**: 600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰
- **æœ€å¤§ç¼“å­˜å¤§å°**: 1000æ¡
- **è¿‡æœŸæ—¶é—´**: è‡ªåŠ¨è®¾ç½®ï¼ˆåˆ›å»ºæ—¶é—´ + TTLï¼‰

### è¿‡æœŸæœºåˆ¶

```python
# è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸ
entry.is_expired()  # True/False

# è®¿é—®æ—¶è‡ªåŠ¨è¿‡æ»¤è¿‡æœŸç¼“å­˜
value = cache.get_cache("key")  # è¿‡æœŸè¿”å›None

# ä¸»åŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
expired_count = cache.clear_expired_cache()
```

---

## ğŸ’¾ å¿«ç…§åŠŸèƒ½ï¼ˆæ’å…¥ä»»åŠ¡æ”¯æŒï¼‰

### ä½¿ç”¨åœºæ™¯

å½“ç”¨æˆ·è§¦å‘æ’å…¥ä»»åŠ¡æ—¶ï¼Œéœ€è¦å¤‡ä»½ä¸»ä»»åŠ¡çš„ç¼“å­˜çŠ¶æ€ï¼Œä»¥ä¾¿æ’å…¥ä»»åŠ¡å®Œæˆåæ¢å¤ã€‚

```python
# 1. åˆ›å»ºæ’å…¥ä»»åŠ¡å‰ï¼Œå…ˆåˆ›å»ºå¿«ç…§
snapshot_id = "toilet_task_snapshot"
cache.snapshot_current_state(snapshot_id, prefix="plan_route.")

# 2. æ’å…¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ¸…é™¤ä¸»ä»»åŠ¡ç¼“å­˜
cache.clear_cache("plan_route.eta")

# 3. æ’å…¥ä»»åŠ¡å®Œæˆï¼Œæ¢å¤å¿«ç…§
cache.restore_from_snapshot(snapshot_id)

# 4. ä¸»ä»»åŠ¡ç¼“å­˜å·²å®Œå…¨æ¢å¤
eta = cache.get_cache("plan_route.eta")  # æ¢å¤æˆåŠŸ
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

```
âœ… è®¾ç½®å’Œè·å–ç¼“å­˜ - é€šè¿‡
âœ… æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ - é€šè¿‡
âœ… æ¸…é™¤è¿‡æœŸç¼“å­˜ - é€šè¿‡
âœ… å¿«ç…§åŠŸèƒ½æµ‹è¯• - é€šè¿‡
âœ… æ•°æ®å®Œæ•´æ€§æµ‹è¯• - é€šè¿‡
âœ… é›†æˆæµ‹è¯• - é€šè¿‡
```

**é›†æˆæµ‹è¯•è¾“å‡ºï¼š**
```
1. ä¸»ä»»åŠ¡æ‰§è¡Œä¸­...
âœ“ ç¼“å­˜æ•°æ®å·²ä¿å­˜

2. åˆ›å»ºæ’å…¥ä»»åŠ¡å¿«ç…§...
âœ“ å¿«ç…§å·²åˆ›å»º: toilet_task_snapshot (3ä¸ªæ¡ç›®)

3. æ’å…¥ä»»åŠ¡æ‰§è¡Œ...
âœ“ æ’å…¥ä»»åŠ¡å·²æ³¨å†Œ
âœ“ æ¸…é™¤äº†éƒ¨åˆ†ç¼“å­˜ï¼Œå‰©ä½™ç¼“å­˜æ•°: 2

4. æ¢å¤ä¸»ä»»åŠ¡...
âœ“ ä¸»ä»»åŠ¡æ¢å¤ç‚¹: goto_department
âœ“ å¿«ç…§å·²æ¢å¤ (3ä¸ªæ¡ç›®)

5. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§...
   ETAæ¢å¤: 30åˆ†é’Ÿ
   è·¯çº¿æ¢å¤: ['ç«™å°A', 'å…¬äº¤B']
   ç”¨æˆ·å›å¤æ¢å¤: è™¹å£åŒ»é™¢
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. ç”Ÿå‘½å‘¨æœŸæ§åˆ¶

```python
# TTLè®¾ç½®
cache.set_cache("key", "value", ttl=60)  # 60ç§’åè¿‡æœŸ

# è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸ
if cache.has_cache("key"):
    # æœªè¿‡æœŸ
    value = cache.get_cache("key")
```

### 2. æ•°æ®éš”ç¦»

- æ”¯æŒé”®å‰ç¼€ç­›é€‰ï¼ˆå¿«ç…§æ—¶ï¼‰
- ä¸»ä»»åŠ¡å’Œæ’å…¥ä»»åŠ¡ç¼“å­˜åˆ†ç¦»
- æ”¯æŒå¤šä¸ªå¿«ç…§å¹¶å­˜

### 3. LRUç­–ç•¥

- ç¼“å­˜æ»¡æ—¶è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ¡ç›®
- æŒ‰æœ€åè®¿é—®æ—¶é—´æ’åº

### 4. è¿‡æœŸè‡ªåŠ¨æ¸…ç†

- è®¿é—®æ—¶è‡ªåŠ¨æ£€æŸ¥è¿‡æœŸ
- å¯ä»¥ä¸»åŠ¨æ¸…ç†æ‰€æœ‰è¿‡æœŸç¼“å­˜

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```python
from task_engine import TaskCacheManager

cache = TaskCacheManager(default_ttl=600)  # 10åˆ†é’Ÿè¿‡æœŸ

# è®¾ç½®ç¼“å­˜
cache.set_cache("plan_route.eta", "18åˆ†é’Ÿ", ttl=300)

# è·å–ç¼“å­˜
eta = cache.get_cache("plan_route.eta")
print(eta)  # è¾“å‡º: 18åˆ†é’Ÿ

# æ£€æŸ¥ç¼“å­˜
if cache.has_cache("plan_route.eta"):
    print("ç¼“å­˜å­˜åœ¨ä¸”æœªè¿‡æœŸ")

# æ¸…é™¤ç¼“å­˜
cache.clear_cache("plan_route.eta")
```

### æ’å…¥ä»»åŠ¡å¿«ç…§

```python
# ä¸»ä»»åŠ¡æ‰§è¡Œä¸­
cache.set_cache("destination", "è™¹å£åŒ»é™¢")
cache.set_cache("user_choice", "äººå·¥çª—å£")

# åˆ›å»ºå¿«ç…§
snapshot_id = "toilet_task_snapshot"
cache.snapshot_current_state(snapshot_id)

# æ’å…¥ä»»åŠ¡æ‰§è¡Œï¼ˆå¯èƒ½ä¿®æ”¹ç¼“å­˜ï¼‰
cache.clear_cache("user_choice")

# æ’å…¥ä»»åŠ¡å®Œæˆï¼Œæ¢å¤å¿«ç…§
cache.restore_from_snapshot(snapshot_id)

# æ•°æ®å·²æ¢å¤
destination = cache.get_cache("destination")  # "è™¹å£åŒ»é™¢"
user_choice = cache.get_cache("user_choice")  # "äººå·¥çª—å£"
```

### è·å–ç¼“å­˜ä¿¡æ¯

```python
info = cache.get_cache_info()

# è¾“å‡º:
# {
#   "total_entries": 10,
#   "valid_entries": 8,
#   "expired_entries": 2,
#   "snapshots_count": 1,
#   "max_size": 1000,
#   "usage_percent": 1
# }
```

---

## ğŸ”§ ç”Ÿå‘½å‘¨æœŸç­–ç•¥

### æ¨èä½¿ç”¨ç­–ç•¥

1. **èŠ‚ç‚¹æ‰§è¡Œåæ¸…ç†è¿‡æœŸç¼“å­˜**
   ```python
   cache.clear_expired_cache()
   ```

2. **æ’å…¥ä»»åŠ¡å‰æ‰§è¡Œå¿«ç…§**
   ```python
   cache.snapshot_current_state(snapshot_id)
   ```

3. **æ’å…¥ä»»åŠ¡åæ¢å¤å¿«ç…§**
   ```python
   cache.restore_from_snapshot(snapshot_id)
   ```

4. **è·¯å¾„åˆ‡æ¢æ—¶é‡ç½®**
   ```python
   cache.clear_all_cache()
   ```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å†…å­˜æ§åˆ¶

- **æœ€å¤§ç¼“å­˜æ•°**: 1000æ¡ï¼ˆå¯é…ç½®ï¼‰
- **è‡ªåŠ¨æ¸…ç†**: è¿‡æœŸæ¡ç›®è‡ªåŠ¨æ¸…ç†
- **LRUç­–ç•¥**: ç¼“å­˜æ»¡æ—¶åˆ é™¤æœ€æ—§çš„

### è®¿é—®ä¼˜åŒ–

- **è‡ªåŠ¨è®¡æ•°**: è®°å½•è®¿é—®æ¬¡æ•°
- **è§¦æ‘¸æ›´æ–°**: æ¯æ¬¡è®¿é—®æ›´æ–°æœ€åè®¿é—®æ—¶é—´
- **è¿‡æœŸæ£€æŸ¥**: åªåœ¨éœ€è¦æ—¶æ£€æŸ¥è¿‡æœŸ

---

## ğŸ”® æ‰©å±•å»ºè®®ï¼ˆv1.5ï¼‰

1. **è®¿é—®é¢‘ç‡å­¦ä¹ **
   - é«˜é¢‘è®¿é—®çš„ç¼“å­˜è‡ªåŠ¨å»¶é•¿TTL
   - æ™ºèƒ½è°ƒæ•´è¿‡æœŸæ—¶é—´

2. **ç”¨æˆ·åå¥½ç¼“å­˜**
   - ç”¨æˆ·é€‰æ‹©åå¥½ç¼“å­˜
   - å¤šè½®å¯¹è¯åˆ¤æ–­å¤ç”¨

3. **å¤šç”¨æˆ·ç¯å¢ƒéš”ç¦»**
   - ç¼“å­˜æŒ‰ user_id éš”ç¦»
   - æ”¯æŒå¤šç”¨æˆ·å¹¶å‘

---

## âœ… å‘åå…¼å®¹

ä¿ç•™äº†ä»¥ä¸‹åŸæœ‰æ–¹æ³•ï¼š

- `add_task()` â†’ `set_cache()`
- `get_task()` â†’ `get_cache()`
- `remove_task()` â†’ `clear_cache()`
- `get_cache_list()` â†’ è¿”å›æ‰€æœ‰é”®åˆ—è¡¨
- `get_usage()` â†’ ç¼“å­˜ä½¿ç”¨æƒ…å†µ

---

## ğŸ“ˆ é›†æˆéªŒè¯

```
âœ… ä¸çŠ¶æ€ç®¡ç†å™¨é›†æˆ - é€šè¿‡
âœ… ä¸æ’å…¥ä»»åŠ¡é˜Ÿåˆ—é›†æˆ - é€šè¿‡
âœ… æ•°æ®å®Œæ•´æ€§ä¿è¯ - é€šè¿‡
âœ… å¿«ç…§æ¢å¤æµ‹è¯• - é€šè¿‡
âœ… ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ - é€šè¿‡
```

---

**task_cache_manager.py æ¨¡å—å®ç°å®Œæˆï¼** ğŸ‰

æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼Œå®Œæ•´æ”¯æŒæ’å…¥ä»»åŠ¡å¿«ç…§å’Œæ¢å¤ï¼
