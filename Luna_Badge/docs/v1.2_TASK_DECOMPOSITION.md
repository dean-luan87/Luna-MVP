# Luna Badge v1.2 任务拆解：剩余功能模块

**版本**: v1.2  
**开发时间**: 2025年10月  
**状态**: 规划中  
**前置版本**: v1.4（任务引擎子系统已完成）

---

## 📋 模块列表

### 模块 1：台阶识别 × 数据持久化

#### 1.1 台阶识别功能
**文件**: `core/step_detector.py`

**功能**:
- 识别楼梯/台阶
- 通过深度估计或视觉特征判断
- 检测台阶高度、宽度、数量
- 判断台阶方向（上/下）
- 输出结构化数据

**输出格式**:
```json
{
  "event": "step_detected",
  "level": "medium",
  "data": {
    "steps_count": 5,
    "direction": "up",
    "height_avg": "15cm",
    "width_avg": "30cm",
    "bbox": [100, 150, 200, 400],
    "confidence": 0.85
  },
  "timestamp": "2025-10-29T15:30:00"
}
```

#### 1.2 数据持久化
**文件**: `core/migrate_step_data_on_device_change.py`

**功能**:
- 记录识别数据并持久化至本地存储
- 绑定账号ID
- 更换设备时自动迁移台阶/结构识别数据
- 实现状态还原

**存储位置**: `data/step_records.json`

**数据格式**:
```json
{
  "account_id": "user_001",
  "records": [
    {
      "step_id": "step_001",
      "location": {"lat": 31.2304, "lng": 121.4737},
      "steps_count": 5,
      "direction": "up",
      "first_detected": "2025-10-28T10:00:00",
      "last_visited": "2025-10-29T14:30:00",
      "visit_count": 3
    }
  ]
}
```

---

### 模块 2：首次开机流程

#### 2.1 首次开机检测
**文件**: `core/first_boot_check.py`

**功能**:
- 判断是否首次开机
- 进入初始化流程
- 创建必要的配置文件和目录

**检测逻辑**:
```python
def first_boot_check():
    if not os.path.exists("data/user_profile.json"):
        return True  # 首次开机
    return False
```

#### 2.2 账号设置流程
**文件**: `core/account_setup_flow.py`

**功能**:
- 创建新账号
- 继承老账号
- 支持语音引导配网
- 扫码配对机制

**流程**:
1. 检测是否为首次开机
2. 如果是首次，创建新账号
3. 如果不是，检查是否有账号备份
4. 语音引导用户选择：
   - 创建新账号
   - 继承老账号（通过扫码或账号密码）
5. 完成网络配置

**输出格式**:
```json
{
  "event": "account_setup_complete",
  "level": "system",
  "data": {
    "account_id": "user_001",
    "account_type": "new",
    "network_configured": true
  },
  "timestamp": "2025-10-29T15:30:00"
}
```

---

### 模块 3：产品语音引导系统

#### 3.1 语音引导功能
**文件**: `core/luna_usage_guide.py`

**功能**:
- 依据模块化内容结构进行逐步语音引导
- 后台可配置引导内容
- 支持触发关键词唤起

**触发方式**:
- 首次启动自动触发
- 用户语音："Luna，怎么用？"
- 用户语音："Luna，帮助"

**引导内容**:
```python
guide_steps = [
    "欢迎使用Luna徽章，我是你的视觉与语音导航助手。",
    "我可以为你导航、识别路标、记录提醒，还可以回答你的问题。",
    "你可以随时说：Luna，怎么用？ 来再次听到这段介绍。",
    "Luna徽章支持多种功能，包括：",
    "1. 智能导航，为你规划最优路线",
    "2. 障碍物识别，提醒你注意安全",
    "3. 记忆功能，记录你的重要事项",
    "4. 语音交互，随时为你服务",
    "开始使用吧，我会陪伴你每一步！"
]
```

**输出格式**:
```json
{
  "event": "usage_guide_started",
  "level": "system",
  "data": {
    "trigger": "first_boot",
    "guide_type": "introduction",
    "step_count": 5
  },
  "timestamp": "2025-10-29T15:30:00"
}
```

---

### 模块 4：硬件编码记录机制

#### 4.1 硬件身份记录
**文件**: `core/hardware_identity_logger.py`

**功能**:
- 记录硬件序列号
- 激活时间
- 使用日志
- 与账号绑定
- 可上传至后台

**记录内容**:
```json
{
  "hardware_id": "LUNA-DEVICE-001",
  "serial_number": "SN12345678",
  "activated_at": "2025-10-29T15:00:00",
  "account_id": "user_001",
  "device_info": {
    "model": "Luna Badge v1.2",
    "firmware_version": "v1.2.0",
    "manufacturing_date": "2025-09-15"
  },
  "usage_log": [
    {
      "timestamp": "2025-10-29T15:00:00",
      "event": "activated",
      "action": "first_boot"
    }
  ]
}
```

**存储位置**: `data/hardware_identity.json`

---

### 模块 5：联网机制设计

#### 5.1 联网策略
**文件**: `core/network_connection_strategy.py`

**功能**:
1. Wi-Fi直连：首次配网支持语音指引或二维码扫码
2. 蓝牙配对辅助联网（可选）
3. IoT卡/eSIM预留（暂不开发）

**Wi-Fi配网流程**:
1. 检测网络状态
2. 如果未连接，启动配网流程
3. 语音引导用户：
   - "请扫描设备上的二维码连接网络"
   - 或者："请告诉我Wi-Fi名称和密码"
4. 连接到Wi-Fi
5. 验证网络连接

**输出格式**:
```json
{
  "event": "network_connected",
  "level": "system",
  "data": {
    "ssid": "Home_WiFi",
    "method": "qr_code",
    "signal_strength": -45,
    "ip_address": "192.168.1.100"
  },
  "timestamp": "2025-10-29T15:30:00"
}
```

---

## 📁 文件结构

```
Luna_Badge/
├── core/
│   ├── step_detector.py                   # 模块1：台阶识别
│   ├── migrate_step_data_on_device_change.py  # 模块1：数据迁移
│   ├── first_boot_check.py                # 模块2：首次开机检测
│   ├── account_setup_flow.py              # 模块2：账号设置流程
│   ├── luna_usage_guide.py                # 模块3：语音引导系统
│   ├── hardware_identity_logger.py        # 模块4：硬件编码记录
│   └── network_connection_strategy.py     # 模块5：联网机制
├── data/
│   ├── step_records.json                  # 台阶识别记录
│   ├── hardware_identity.json             # 硬件身份记录
│   └── usage_guide.json                   # 语音引导配置
└── docs/
    └── v1.2_TASK_DECOMPOSITION.md         # 本文档
```

---

## 🎯 开发优先级

| 模块 | 优先级 | 依赖关系 | 预计工作量 |
|------|--------|----------|-----------|
| 模块2：首次开机流程 | P0 | 无 | 2天 |
| 模块3：语音引导系统 | P0 | 模块2 | 1天 |
| 模块4：硬件编码记录 | P1 | 模块2 | 1天 |
| 模块5：联网机制 | P1 | 模块2 | 2天 |
| 模块1：台阶识别 | P2 | 无 | 3天 |

**总计预计工作量**: 9天

---

## 📝 后续补充

### 语音引导文案结构
- 支持多语言切换
- 支持自定义引导内容
- 支持分步骤播放

### 联网界面
- 二维码生成界面
- 网络连接状态显示
- Wi-Fi列表显示

### 账户输入方式
- 语音输入账号
- 扫码绑定账号
- 账号密码登录

---

**文档生成日期**: 2025-10-29  
**版本**: v1.2  
**状态**: 规划中
