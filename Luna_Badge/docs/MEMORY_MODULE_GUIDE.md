# Luna è®°å¿†æ¨¡å—ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

è®°å¿†æ¨¡å—æä¾›ç”¨æˆ·ç«¯ç¼“å­˜ç®¡ç†å’Œåå°åˆ†ææ•°æ®ä¸Šä¼ åŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [ç¼“å­˜ç®¡ç†](#ç¼“å­˜ç®¡ç†)
3. [t+1ä¸Šä¼ æœºåˆ¶](#t+1ä¸Šä¼ æœºåˆ¶)
4. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è®°å¿†æ¨¡å—æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ç¼“å­˜ç®¡ç†å™¨  â”‚  â”€â”€â–º  â”‚  åå°ä¸Šä¼ å™¨  â”‚                â”‚
â”‚  â”‚              â”‚      â”‚              â”‚                â”‚
â”‚  â”‚ - åœ°å›¾ç¼“å­˜   â”‚      â”‚ - WiFiæ£€æµ‹   â”‚                â”‚
â”‚  â”‚ - åœºæ™¯ç¼“å­˜   â”‚      â”‚ - t+1ä¸Šä¼     â”‚                â”‚
â”‚  â”‚ - è¡Œä¸ºè®°å½•   â”‚      â”‚ - é˜Ÿåˆ—ç®¡ç†   â”‚                â”‚
â”‚  â”‚ - åå¥½è®¾ç½®   â”‚      â”‚              â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                      â”‚                        â”‚
â”‚          â–¼                      â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚        æœ¬åœ°ç¼“å­˜å­˜å‚¨                â”‚                   â”‚
â”‚  â”‚  - maps_cache.json                â”‚                   â”‚
â”‚  â”‚  - scenes_cache.json              â”‚                   â”‚
â”‚  â”‚  - user_behavior_cache.json       â”‚                   â”‚
â”‚  â”‚  - upload_queue.json              â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                           â”‚
â”‚          â–²                      â–¼                        â”‚
â”‚          â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚          â”‚                â”‚   äº‘ç«¯å­˜å‚¨    â”‚               â”‚
â”‚          â”‚                â”‚              â”‚               â”‚
â”‚          â”‚                â”‚ - S3/OSS     â”‚               â”‚
â”‚          â”‚                â”‚ - æ•°æ®åˆ†æ   â”‚               â”‚
â”‚          â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¼“å­˜ç®¡ç†

### åœ°å›¾ç¼“å­˜

```python
from core.memory_cache_manager import MemoryCacheManager

cache_manager = MemoryCacheManager()

# ç¼“å­˜åœ°å›¾
map_data = {
    "map_id": "hospital_main",
    "path_name": "åŒ»é™¢å¯¼èˆªè·¯å¾„",
    "nodes": [...]
}

metadata = {
    "created_at": "2025-10-30T10:00:00",
    "regions": ["æŒ‚å·å¤§å…", "ä¸‰æ¥¼ç—…åŒº"]
}

cache_manager.cache_map(map_data, metadata)
```

### åœºæ™¯è®°å¿†ç¼“å­˜

```python
# ç¼“å­˜åœºæ™¯
scene_data = {
    "scene_id": "scene_001",
    "location": "è™¹å£åŒ»é™¢",
    "caption": "åŒ»é™¢å…¥å£",
    "image_path": "data/scenes/scene_001.jpg"
}

cache_manager.cache_scene(scene_data)
```

### ç”¨æˆ·è¡Œä¸ºè®°å½•

```python
# è®°å½•å¯¼èˆªäº‹ä»¶
cache_manager.record_navigation_event("start_navigation", {
    "destination": "è™¹å£åŒ»é™¢",
    "route_type": "walking",
    "distance": 1000,
    "start_time": "2025-10-30T10:00:00"
})

# è®°å½•è¯­éŸ³äº¤äº’
cache_manager.record_voice_interaction("voice_command", {
    "command": "å¯¼èˆªåˆ°è™¹å£åŒ»é™¢",
    "result": "success",
    "response_time": 0.5
})

# è®°å½•åå¥½å˜åŒ–
cache_manager.update_user_preferences({
    "voice_speed": "normal",
    "prefer_walk": True,
    "avoid_transfer": False
})
```

### è·å–ç¼“å­˜ç»Ÿè®¡

```python
stats = cache_manager.get_cache_stats()
print(f"æ€»åœ°å›¾æ•°: {stats['total_maps']}")
print(f"æœªä¸Šä¼ : {stats['unuploaded_maps']}")
print(f"ç¼“å­˜å¤§å°: {stats['cache_size_kb']} KB")
```

---

## t+1ä¸Šä¼ æœºåˆ¶

### è®¾è®¡åŸç†

**t+1æœºåˆ¶**ï¼šä¸Šæ¬¡ä¸Šä¼ åè‡³å°‘é—´éš”1å°æ—¶æ‰è¿›è¡Œä¸‹ä¸€æ¬¡ä¸Šä¼ 

**ä¼˜åŠ¿**ï¼š
- âœ… èŠ‚çœæµé‡ï¼šæ‰¹é‡ä¸Šä¼ ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- âœ… é™ä½åŠŸè€—ï¼šå‡å°‘é¢‘ç¹ä¸Šä¼ å¯¹ç”µæ± çš„å½±å“
- âœ… æ™ºèƒ½è§¦å‘ï¼šåªåœ¨WiFiç¯å¢ƒä¸‹è‡ªåŠ¨ä¸Šä¼ 
- âœ… æ•°æ®èšåˆï¼šä¸€å°æ—¶å†…çš„æ•°æ®åˆå¹¶ä¸Šä¼ 

### å®ç°æµç¨‹

```python
from core.background_uploader import BackgroundUploader

# å®šä¹‰ä¸Šä¼ å‡½æ•°
def upload_to_cloud(upload_package):
    """å®é™…ä¸Šä¼ å‡½æ•°"""
    import requests
    
    try:
        response = requests.post(
            "https://api.luna-project.com/v1/upload",
            json=upload_package,
            headers={"Authorization": f"Bearer {api_key}"},
            timeout=30
        )
        
        if response.status_code == 200:
            return {"success": True}
        else:
            return {"success": False, "error": response.text}
    except Exception as e:
        return {"success": False, "error": str(e)}

# åˆå§‹åŒ–ä¸Šä¼ å™¨
cache_manager = MemoryCacheManager()
uploader = BackgroundUploader(
    cache_manager=cache_manager,
    upload_func=upload_to_cloud,
    wifi_check_interval=30,      # 30ç§’æ£€æµ‹ä¸€æ¬¡WiFi
    upload_check_interval=300    # 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä¸Šä¼ 
)

# å¯åŠ¨åå°ä¸Šä¼ æœåŠ¡
uploader.start()

# åœæ­¢æœåŠ¡ï¼ˆåº”ç”¨é€€å‡ºæ—¶ï¼‰
uploader.stop()
```

### WiFiæ£€æµ‹

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹WiFiè¿æ¥çŠ¶æ€ï¼š

```python
# macOS
uploader.is_wifi_connected  # True/False

# Linux/RV1126
# ä½¿ç”¨nmcliå‘½ä»¤æ£€æµ‹
```

### æ‰‹åŠ¨å¼ºåˆ¶ä¸Šä¼ 

```python
# ç«‹å³ä¸Šä¼ ï¼ˆä¸ç­‰å¾…t+1ï¼‰
success = uploader.force_upload_now()

if success:
    print("âœ… ä¸Šä¼ æˆåŠŸ")
else:
    print("âŒ ä¸Šä¼ å¤±è´¥")
```

### è·å–ä¸Šä¼ çŠ¶æ€

```python
status = uploader.get_status()

print(f"WiFiè¿æ¥: {status['is_wifi_connected']}")
print(f"ä¸Šæ¬¡ä¸Šä¼ : {status['last_upload_time']}")
print(f"å¾…ä¸Šä¼ : {status['pending_uploads']}")
```

---

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹

```python
#!/usr/bin/env python3
"""Luna è®°å¿†æ¨¡å—å®Œæ•´ç¤ºä¾‹"""

import logging
from core.memory_cache_manager import MemoryCacheManager
from core.background_uploader import BackgroundUploader

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def main():
    # 1. åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
    cache_manager = MemoryCacheManager(cache_dir="data/cache")
    
    # 2. å®šä¹‰ä¸Šä¼ å‡½æ•°
    def upload_to_cloud(upload_package):
        """å®é™…ä¸Šä¼ å‡½æ•°ï¼ˆæ›¿æ¢ä¸ºçœŸå®APIï¼‰"""
        print(f"ğŸ“¤ ä¸Šä¼ æ•°æ®åŒ…: {len(upload_package['maps'])}ä¸ªåœ°å›¾")
        return {"success": True}
    
    # 3. åˆå§‹åŒ–ä¸Šä¼ å™¨
    uploader = BackgroundUploader(
        cache_manager=cache_manager,
        upload_func=upload_to_cloud
    )
    
    # 4. æ¨¡æ‹Ÿä½¿ç”¨åœºæ™¯
    print("=" * 60)
    print("ğŸ¨ æ¨¡æ‹Ÿä½¿ç”¨åœºæ™¯")
    print("=" * 60)
    
    # ç”¨æˆ·ç”Ÿæˆåœ°å›¾
    print("\n1. ç”¨æˆ·ç”Ÿæˆåœ°å›¾...")
    map_data = {
        "map_id": "test_hospital",
        "path_name": "åŒ»é™¢å¯¼èˆª",
        "nodes": [
            {"node_id": "n1", "label": "å…¥å£", "type": "entrance"},
            {"node_id": "n2", "label": "è¯Šå®¤", "type": "destination"}
        ]
    }
    cache_manager.cache_map(map_data)
    
    # ç”¨æˆ·å¯¼èˆª
    print("2. ç”¨æˆ·å¼€å§‹å¯¼èˆª...")
    cache_manager.record_navigation_event("start_navigation", {
        "destination": "è™¹å£åŒ»é™¢",
        "route": "walking"
    })
    
    # è¯­éŸ³äº¤äº’
    print("3. ç”¨æˆ·è¯­éŸ³äº¤äº’...")
    cache_manager.record_voice_interaction("voice_command", {
        "command": "å¯¼èˆªåˆ°è™¹å£åŒ»é™¢",
        "result": "success"
    })
    
    # 5. æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
    print("\n4. ç¼“å­˜ç»Ÿè®¡...")
    stats = cache_manager.get_cache_stats()
    print(f"  æ€»åœ°å›¾æ•°: {stats['total_maps']}")
    print(f"  æœªä¸Šä¼ : {stats['unuploaded_maps']}")
    print(f"  ç¼“å­˜å¤§å°: {stats['cache_size_kb']} KB")
    
    # 6. å¯åŠ¨åå°ä¸Šä¼ 
    print("\n5. å¯åŠ¨åå°ä¸Šä¼ æœåŠ¡...")
    uploader.start()
    
    # 7. æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
    status = uploader.get_status()
    print(f"  WiFiè¿æ¥: {status['is_wifi_connected']}")
    print(f"  æœåŠ¡è¿è¡Œ: {status['is_running']}")
    
    # 8. å¼ºåˆ¶ä¸Šä¼ ï¼ˆæµ‹è¯•ï¼‰
    print("\n6. å¼ºåˆ¶ä¸Šä¼ æµ‹è¯•...")
    uploader.force_upload_now()
    
    # 9. åœæ­¢æœåŠ¡
    print("\n7. åœæ­¢æœåŠ¡...")
    uploader.stop()

if __name__ == "__main__":
    main()
```

---

## æ•°æ®ä¸Šä¼ åŒ…ç»“æ„

ä¸Šä¼ åŒ…æ ¼å¼ï¼š

```json
{
  "timestamp": "2025-10-30T17:00:00",
  "maps": [
    {
      "map_id": "hospital_main",
      "path_name": "åŒ»é™¢å¯¼èˆªè·¯å¾„",
      "nodes": [...],
      "metadata": {...}
    }
  ],
  "scenes": [
    {
      "scene_id": "scene_001",
      "location": "è™¹å£åŒ»é™¢",
      "caption": "åŒ»é™¢å…¥å£",
      "cached_at": "2025-10-30T10:00:00"
    }
  ],
  "behaviors": [
    {
      "behavior_type": "navigation",
      "data": {
        "event_type": "start_navigation",
        "data": {...},
        "timestamp": "2025-10-30T10:00:00"
      }
    }
  ],
  "preferences": {
    "voice_speed": "normal",
    "prefer_walk": true
  },
  "metadata": {
    "maps_count": 1,
    "scenes_count": 1,
    "behaviors_count": 5
  }
}
```

---

## æœ€ä½³å®è·µ

### 1. å†…å­˜ç®¡ç†

```python
# å®šæœŸæ¸…ç†å·²ä¸Šä¼ çš„æ—§æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
cache_manager.cleanup_old_uploaded_data(days=30)
```

### 2. é”™è¯¯å¤„ç†

```python
try:
    cache_manager.cache_map(map_data)
except Exception as e:
    logger.error(f"ç¼“å­˜å¤±è´¥: {e}")
    # é™çº§å¤„ç†ï¼šä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
```

### 3. æ•°æ®å‹ç¼©

```python
# å¤§æ–‡ä»¶å…ˆå‹ç¼©å†ç¼“å­˜
import gzip

compressed_data = gzip.compress(json.dumps(map_data).encode())
cache_manager.cache_compressed_map(compressed_data)
```

### 4. éšç§ä¿æŠ¤

```python
# æ•æ„Ÿæ•°æ®è„±æ•å¤„ç†
def anonymize_data(data):
    # ç§»é™¤ä¸ªäººä¿¡æ¯
    data.pop("user_name", None)
    data.pop("phone_number", None)
    return data

cache_manager.cache_map(anonymize_data(map_data))
```

---

## æ€»ç»“

è®°å¿†æ¨¡å—æä¾›äº†ï¼š

- âœ… **æœ¬åœ°ç¼“å­˜**ï¼šå¿«é€Ÿè¯»å†™ï¼Œç¦»çº¿å¯ç”¨
- âœ… **t+1ä¸Šä¼ **ï¼šæ™ºèƒ½æ‰¹é‡ä¸Šä¼ ï¼ŒèŠ‚çœèµ„æº
- âœ… **WiFiæ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒ
- âœ… **é˜Ÿåˆ—ç®¡ç†**ï¼šå¯é çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ
- âœ… **æ•°æ®åˆ†æ**ï¼šä¸°å¯Œçš„è¡Œä¸ºæ•°æ®é‡‡é›†

**æ ¸å¿ƒä»·å€¼**ï¼šè®©LunaçœŸæ­£ç†è§£ç”¨æˆ·ï¼ŒæŒç»­ä¼˜åŒ–ä½“éªŒï¼

