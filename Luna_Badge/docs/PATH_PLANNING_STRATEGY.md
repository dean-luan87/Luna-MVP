# Luna Badge è·¯å¾„è§„åˆ’ç­–ç•¥è¯¦è§£

**ç‰ˆæœ¬**: v1.6  
**æ–‡æ¡£æ—¥æœŸ**: 2025-10-30  
**ä¸»é¢˜**: å¤šç›®çš„åœ°å¯¼èˆªå’Œè·¯å¾„åˆå¹¶ç­–ç•¥

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜åˆ†æ](#é—®é¢˜åˆ†æ)
2. [è§£å†³æ–¹æ¡ˆè®¾è®¡](#è§£å†³æ–¹æ¡ˆè®¾è®¡)
3. [åœ°å›¾ç”Ÿæˆç­–ç•¥](#åœ°å›¾ç”Ÿæˆç­–ç•¥)
4. [è·¯å¾„è§„åˆ’åœºæ™¯](#è·¯å¾„è§„åˆ’åœºæ™¯)
5. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## ğŸ¯ é—®é¢˜åˆ†æ

### é—®é¢˜1: åœ°å›¾ç”Ÿæˆæ–¹å¼
**Q**: ç°åœ¨ç”Ÿæˆçš„åœ°å›¾æ˜¯é›†åˆåœ¨ä¸€èµ·çš„ï¼Œè¿˜æ˜¯ä¸€ä¸ªç›®çš„åœ°ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Ÿ

**A**: å½“å‰æ¯ä¸ªè·¯å¾„ç‹¬ç«‹ç”Ÿæˆä¸€ä¸ªåœ°å›¾æ–‡ä»¶ã€‚

**å½“å‰è¡Œä¸º**:
- æ¯ä¸ª `path_id` å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„åœ°å›¾æ–‡ä»¶
- ä¾‹å¦‚ï¼š`path_a_to_b_map.png` å’Œ `path_a_to_c_map.png`
- åœ°å›¾ä¹‹é—´æ²¡æœ‰å…³è”

**å»ºè®®æ”¹è¿›**:
- æ”¯æŒå•ä¸€è·¯å¾„åœ°å›¾ï¼ˆå½“å‰æ–¹å¼ï¼‰
- æ”¯æŒåˆå¹¶è·¯å¾„åœ°å›¾ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰

### é—®é¢˜2: å¤šç›®çš„åœ°å¯¼èˆª
**Q**: å½“å‡ºç°å¤šä¸ªç›®çš„åœ°ï¼ˆä»Aåˆ°Bå†åˆ°Cï¼‰æ—¶ï¼Œä¼šæ€ä¹ˆå¤„ç†ï¼Ÿ

**A**: ä½¿ç”¨æ™ºèƒ½è·¯å¾„è§„åˆ’ç®—æ³•å¤„ç†ã€‚

**åœºæ™¯åˆ†æ**:
- **å·²çŸ¥è·¯å¾„**: Aâ†’B, Aâ†’C éƒ½å­˜åœ¨
- **ç›®æ ‡**: ä»Aå‡ºå‘ï¼Œä¾æ¬¡è®¿é—®Bå’ŒC
- **å¤„ç†æ–¹å¼**: è‡ªåŠ¨è§„åˆ’ Aâ†’Bâ†’C çš„è¿ç»­è·¯å¾„

### é—®é¢˜3: è·¯å¾„ç¼ºå¤±å¤„ç†
**Q**: å¦‚æœæœ‰Aåˆ°Bçš„è·¯å¾„ï¼ŒAåˆ°Cçš„è·¯å¾„ï¼Œä½†ç¼ºå°‘Båˆ°Cçš„è·¯å¾„ï¼Œä¼šå‡ºç°è®©ç”¨æˆ·å›é€€åˆ°Aç‚¹ï¼Œå†å‰å¾€Cç‚¹çš„æƒ…å†µå—ï¼Ÿ

**A**: é»˜è®¤æƒ…å†µä¸‹ä¼šï¼Œä½†æä¾›å¤šç§ç­–ç•¥é€‰æ‹©ã€‚

---

## ğŸ—ï¸ è§£å†³æ–¹æ¡ˆè®¾è®¡

### ç­–ç•¥1: æ™ºèƒ½åˆå¹¶ (smart_merge) â­æ¨è

**è¡Œä¸º**:
1. å°è¯•é€šè¿‡å…±åŒç¥–å…ˆèŠ‚ç‚¹è¿æ¥
2. å¦‚æœæ‰¾ä¸åˆ°å…±åŒè·¯å¾„ï¼Œå¯åŠ¨å®æ—¶è·¯å¾„è®°å½•æ¨¡å¼
3. è¾¹è®°å½•è¾¹å¯¼èˆªï¼Œé€æ­¥æ„å»ºå®Œæ•´è·¯å¾„å›¾

**ä¼˜ç‚¹**:
- ä¸ä¼šå¼ºåˆ¶ç”¨æˆ·å›é€€
- è‡ªåŠ¨å­¦ä¹ æ–°è·¯å¾„
- é€æ­¥ç§¯ç´¯çŸ¥è¯†

**ç¤ºä¾‹**:
```
ç”¨æˆ·éœ€æ±‚: B -> C (æœªçŸ¥è·¯å¾„)

ç­–ç•¥æ‰§è¡Œ:
1. æ£€æµ‹åˆ°B->Cè·¯å¾„æœªçŸ¥
2. è¯¢é—®ç”¨æˆ·: "éœ€è¦è®°å½•ä»Båˆ°Cçš„æ–°è·¯å¾„å—ï¼Ÿ"
3. å¦‚æœç¡®è®¤: å¯åŠ¨è·¯å¾„è®°å½•æ¨¡å¼
4. è¾¹èµ°è·¯è¾¹è¯†åˆ«èŠ‚ç‚¹ï¼Œç”Ÿæˆæ–°è·¯å¾„
5. ä¿å­˜åä¸‹æ¬¡å³å¯ç›´æ¥ä½¿ç”¨
```

### ç­–ç•¥2: å›é€€ç­–ç•¥ (fallback)

**è¡Œä¸º**:
1. é‡åˆ°æœªçŸ¥è·¯å¾„ï¼Œå»ºè®®å›é€€åˆ°æœ€è¿‘çš„å·²çŸ¥èŠ‚ç‚¹
2. é€šè¿‡å·²çŸ¥è·¯å¾„åˆ°è¾¾ç›®æ ‡

**ä¼˜ç‚¹**:
- ç¡®ä¿è·¯å¾„å¯é æ€§
- é¿å…è¿·è·¯

**ç¼ºç‚¹**:
- å¯èƒ½éœ€è¦èµ°å›å¤´è·¯
- æ•ˆç‡è¾ƒä½

**ç¤ºä¾‹**:
```
ç”¨æˆ·éœ€æ±‚: B -> C (æœªçŸ¥è·¯å¾„)

ç­–ç•¥æ‰§è¡Œ:
1. æ£€æµ‹åˆ°B->Cè·¯å¾„æœªçŸ¥
2. åˆ†æ: Bå¯ä»¥é€šè¿‡B->Startè¿æ¥ï¼ŒCå¯ä»¥é€šè¿‡Start->Cè¿æ¥
3. å»ºè®®: "è¯·å›é€€åˆ°Startï¼Œç„¶åå‰å¾€C"
```

### ç­–ç•¥3: è¯¢é—®ç”¨æˆ· (ask_user)

**è¡Œä¸º**:
1. é‡åˆ°æœªçŸ¥è·¯å¾„ï¼Œç›´æ¥è¯¢é—®ç”¨æˆ·
2. æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šç­–ç•¥

**ä¼˜ç‚¹**:
- çµæ´»æ€§é«˜
- å°Šé‡ç”¨æˆ·æ„æ„¿

**ç¼ºç‚¹**:
- éœ€è¦ç”¨æˆ·äº¤äº’
- å¯èƒ½æ‰“æ–­å¯¼èˆªæµç¨‹

---

## ğŸ—ºï¸ åœ°å›¾ç”Ÿæˆç­–ç•¥

### æ–¹å¼1: ç‹¬ç«‹è·¯å¾„åœ°å›¾ï¼ˆå½“å‰ï¼‰

**é€‚ç”¨åœºæ™¯**: ç‹¬ç«‹çš„ç›®çš„åœ°å¯¼èˆª

**ç”Ÿæˆæ–¹å¼**:
```python
generator = MapCardGenerator()
map_path = generator.generate_map_card(path_memory, "hospital_visit_map.png")
```

**æ–‡ä»¶ç»“æ„**:
```
data/map_cards/
â”œâ”€â”€ path_a_to_b_map.png
â”œâ”€â”€ path_a_to_c_map.png
â””â”€â”€ path_b_to_c_map.png
```

### æ–¹å¼2: åˆå¹¶è·¯å¾„åœ°å›¾ï¼ˆæ–°å¢ï¼‰

**é€‚ç”¨åœºæ™¯**: è¿ç»­å¤šç›®çš„åœ°å¯¼èˆª

**ç”Ÿæˆæ–¹å¼**:
```python
from core.path_planner import PathPlanner

planner = PathPlanner(system)

# åˆå¹¶å¤šæ¡è·¯å¾„
merged = planner.merge_paths_to_continuous(["path_a_to_b", "path_a_to_c"])

# ç”Ÿæˆåˆå¹¶åœ°å›¾
generator = MapCardGenerator()
map_path = generator.generate_map_card_from_nodes(merged['merged_nodes'], "combined_map.png")
```

**æ–‡ä»¶ç»“æ„**:
```
data/map_cards/
â”œâ”€â”€ combined_route.png  # åˆå¹¶åçš„è¿ç»­è·¯å¾„
â””â”€â”€ path_details/
    â”œâ”€â”€ path_a_to_b_map.png
    â””â”€â”€ path_a_to_c_map.png
```

---

## ğŸ“Š è·¯å¾„è§„åˆ’åœºæ™¯

### åœºæ™¯1: å®Œæ•´å·²çŸ¥è·¯å¾„

```
å·²çŸ¥è·¯å¾„:
  - A -> B (Path1)
  - A -> C (Path2)

ç”¨æˆ·éœ€æ±‚: A -> B -> C

å¤„ç†æµç¨‹:
  1. æŸ¥æ‰¾ A -> B: âœ… æ‰¾åˆ° (ä½¿ç”¨Path1)
  2. æŸ¥æ‰¾ B -> C: âŒ æœªæ‰¾åˆ°
  3. åº”ç”¨ç­–ç•¥: smart_merge
  4. æ‰§è¡Œ: å¯åŠ¨B->Cè·¯å¾„è®°å½•æ¨¡å¼
  5. ç»“æœ: è¾¹è®°å½•è¾¹å¯¼èˆª
```

### åœºæ™¯2: é€šè¿‡å›é€€è¿æ¥

```
å·²çŸ¥è·¯å¾„:
  - A -> B (Path1)
  - A -> C (Path2)
  - å…±åŒèŠ‚ç‚¹: A

ç”¨æˆ·éœ€æ±‚: B -> C

å¤„ç†æµç¨‹:
  1. æŸ¥æ‰¾ B -> C: âŒ æœªæ‰¾åˆ°
  2. æŸ¥æ‰¾å…±åŒç¥–å…ˆ: âœ… æ‰¾åˆ° A
  3. åº”ç”¨ç­–ç•¥: fallback
  4. å»ºè®®: "å›é€€åˆ°Aï¼Œå†ä»Aå‰å¾€C"
  5. ç»“æœ: B -> A -> C
```

### åœºæ™¯3: æ™ºèƒ½å­¦ä¹ è·¯å¾„

```
å·²çŸ¥è·¯å¾„:
  - A -> B (Path1)
  
ç”¨æˆ·éœ€æ±‚: A -> B -> C (ç¬¬ä¸€æ¬¡è®¿é—®C)

å¤„ç†æµç¨‹:
  1. A -> B: âœ… å·²çŸ¥è·¯å¾„
  2. B -> C: âŒ æœªçŸ¥è·¯å¾„
  3. åº”ç”¨ç­–ç•¥: smart_merge
  4. è¯¢é—®: "å¼€å§‹è®°å½•Båˆ°Cçš„æ–°è·¯å¾„ï¼Ÿ"
  5. ç¡®è®¤å: å¯åŠ¨è·¯å¾„è®°å½•
  6. è¡Œèµ°è¿‡ç¨‹ä¸­è¯†åˆ«èŠ‚ç‚¹å¹¶ä¿å­˜
  7. å®Œæˆè®°å½•ï¼Œç”Ÿæˆæ–°è·¯å¾„
  8. ä¸‹æ¬¡å³å¯ç›´æ¥ä½¿ç”¨B->Cè·¯å¾„
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: å¤šç›®çš„åœ°è§„åˆ’

```python
from core.scene_memory_system import get_scene_memory_system
from core.path_planner import PathPlanner

# åˆå§‹åŒ–
system = get_scene_memory_system()
planner = PathPlanner(system)

# è®¾ç½®ç­–ç•¥
planner.preferred_strategy = "smart_merge"

# è§„åˆ’è·¯å¾„
result = planner.plan_route(
    start="æŒ‚å·å¤„",
    destinations=["æ£€æŸ¥å®¤", "è¯æˆ¿", "å‡ºå£"]
)

# å¤„ç†ç»“æœ
if result['can_navigate']:
    if result['strategy'] == "direct":
        # å®Œæ•´è·¯å¾„å·²çŸ¥ï¼Œç›´æ¥å¯¼èˆª
        speak("å¼€å§‹å¯¼èˆª")
        navigate(result['segments'])
    else:
        # éœ€è¦å­¦ä¹ æ–°è·¯å¾„
        speak(result['message'])
        # å¯åŠ¨è·¯å¾„è®°å½•æ¨¡å¼
        record_new_segments(result['unknown_segments'])
```

### ç¤ºä¾‹2: è·¯å¾„åˆå¹¶

```python
# åˆå¹¶å¤šæ¡è·¯å¾„
merged = planner.merge_paths_to_continuous([
    "hospital_path_morning",
    "hospital_path_afternoon"
])

# ç”Ÿæˆåˆå¹¶åœ°å›¾
generator = MapCardGenerator()
map_path = generator.generate_map_card_from_merged(merged)
```

### ç¤ºä¾‹3: ç­–ç•¥é€‰æ‹©

```python
# æ ¹æ®åœºæ™¯é€‰æ‹©ç­–ç•¥
situations = {
    "ç†Ÿæ‚‰ç¯å¢ƒ": "smart_merge",      # æ™ºèƒ½å­¦ä¹ 
    "é¦–æ¬¡è®¿é—®": "ask_user",         # è¯¢é—®ç”¨æˆ·
    "ç´§æ€¥æƒ…å†µ": "fallback",         # å¯é ä¼˜å…ˆ
}

planner.preferred_strategy = situations["ç†Ÿæ‚‰ç¯å¢ƒ"]
```

---

## ğŸ¨ åœ°å›¾ç”Ÿæˆæœºåˆ¶

### å•è·¯å¾„åœ°å›¾

```python
# ç”Ÿæˆå•ä¸ªè·¯å¾„çš„åœ°å›¾
path_memory = system.get_path_memory("hospital_visit")
generator.generate_map_card(path_memory, "hospital_visit_map.png")
```

**ç‰¹ç‚¹**:
- ä¸“æ³¨äºå•ä¸€è·¯å¾„
- æ¸…æ™°ç®€æ´
- é€‚åˆå•æ¬¡å¯¼èˆª

### åˆå¹¶è·¯å¾„åœ°å›¾

```python
# ç”Ÿæˆåˆå¹¶è·¯å¾„çš„åœ°å›¾
merged = planner.merge_paths_to_continuous(["path1", "path2", "path3"])
generator.generate_combined_map_card(merged, "combined_route_map.png")
```

**ç‰¹ç‚¹**:
- å±•ç¤ºå®Œæ•´è·¯çº¿
- åŒ…å«æ‰€æœ‰å…³é”®èŠ‚ç‚¹
- é€‚åˆå¤šç›®çš„åœ°è§„åˆ’

### åˆ†å±‚åœ°å›¾

```python
# ç”Ÿæˆå¤šå±‚åœ°å›¾ï¼ˆä¸åŒè·¯å¾„ç”¨ä¸åŒé¢œè‰²ï¼‰
paths = {
    "ä¸»è·¯å¾„": "path_main",
    "å¤‡ç”¨è·¯å¾„": "path_backup"
}
generator.generate_layered_map(paths, "layered_map.png")
```

**ç‰¹ç‚¹**:
- åŒæ—¶å±•ç¤ºå¤šæ¡è·¯å¾„
- ç”¨é¢œè‰²åŒºåˆ†
- é€‚åˆè·¯å¾„å¯¹æ¯”

---

## ğŸ”„ è·¯å¾„å­¦ä¹ æœºåˆ¶

### å®æ—¶å­¦ä¹ æ¨¡å¼

```
1. æ£€æµ‹åˆ°æœªçŸ¥è·¯å¾„
   â†“
2. è¯¢é—®ç”¨æˆ·æ˜¯å¦è®°å½•
   â†“
3. ç”¨æˆ·ç¡®è®¤åå¯åŠ¨è®°å½•
   â†“
4. æ‘„åƒå¤´è¿ç»­è¯†åˆ«èŠ‚ç‚¹
   â†“
5. è‡ªåŠ¨ä¿å­˜èŠ‚ç‚¹å’Œå›¾åƒ
   â†“
6. ç”Ÿæˆå®Œæ•´è·¯å¾„
   â†“
7. ä¸‹æ¬¡å³å¯ä½¿ç”¨æ–°è·¯å¾„
```

### æ¸è¿‘å¼æ„å»º

```
ç¬¬ä¸€æ¬¡: A -> B
ç¬¬äºŒæ¬¡: A -> C
ç¬¬ä¸‰æ¬¡: B -> C (æ™ºèƒ½å­¦ä¹ )

ç»“æœ: å®Œæ•´çš„è·¯å¾„å›¾
```

---

## ğŸ“Š ç­–ç•¥å¯¹æ¯”è¡¨

| ç­–ç•¥ | å¯é æ€§ | æ•ˆç‡ | ç”¨æˆ·ä½“éªŒ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|----------|
| **smart_merge** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | æ—¥å¸¸ä½¿ç”¨ |
| **fallback** | â­â­â­â­â­ | â­â­ | â­â­â­ | ç´§æ€¥æƒ…å†µ |
| **ask_user** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | é¦–æ¬¡è®¿é—® |

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. åœ°å›¾å­˜å‚¨å»ºè®®

```
data/map_cards/
â”œâ”€â”€ single_paths/          # ç‹¬ç«‹è·¯å¾„
â”‚   â”œâ”€â”€ hospital_visit.png
â”‚   â””â”€â”€ shopping_route.png
â”œâ”€â”€ combined/              # åˆå¹¶è·¯å¾„
â”‚   â”œâ”€â”€ multi_dest_route.png
â”‚   â””â”€â”€ complex_nav.png
â””â”€â”€ archived/              # å†å²è®°å½•
    â””â”€â”€ old_paths/
```

### 2. è·¯å¾„å‘½åè§„èŒƒ

```python
# å»ºè®®ä½¿ç”¨æè¿°æ€§å‘½å
path_names = [
    "hospital_path_main_entrance_to_pharmacy",
    "shopping_mall_parking_to_store_305",
    "apartment_building_lobby_to_room_501"
]
```

### 3. è·¯å¾„åˆå¹¶æ¡ä»¶

```python
# è‡ªåŠ¨åˆå¹¶æ¡ä»¶
auto_merge_conditions = {
    "same_building": True,      # åŒä¸€å»ºç­‘å†…
    "time_proximity": True,     # æ—¶é—´ç›¸è¿‘
    "user_tagged": True         # ç”¨æˆ·æ ‡è®°çš„
}
```

---

## ğŸ“ æ€»ç»“

### å›ç­”æ‚¨çš„æ ¸å¿ƒé—®é¢˜

1. **åœ°å›¾ç”Ÿæˆ**: å½“å‰æ¯ä¸ªè·¯å¾„ä¸€ä¸ªæ–‡ä»¶ï¼Œæ”¯æŒåˆå¹¶åœ°å›¾
2. **å¤šç›®çš„åœ°**: è‡ªåŠ¨è§„åˆ’è¿ç»­è·¯å¾„ï¼Œæ™ºèƒ½å¤„ç†
3. **è·¯å¾„ç¼ºå¤±**: é»˜è®¤ä¸å›é€€ï¼ˆsmart_mergeï¼‰ï¼Œå¯é€‰æ‹©å›é€€ç­–ç•¥
4. **è·¯å¾„å­¦ä¹ **: è¾¹èµ°è¾¹ç”Ÿæˆï¼Œæ¸è¿›å¼æ„å»ºçŸ¥è¯†å›¾è°±

### æ¨èé…ç½®

```python
# æ¨èçš„é»˜è®¤é…ç½®
recommended_config = {
    "strategy": "smart_merge",           # æ™ºèƒ½å­¦ä¹ 
    "map_generation": "both",            # ç”Ÿæˆç‹¬ç«‹å’Œåˆå¹¶åœ°å›¾
    "auto_record": True,                 # è‡ªåŠ¨è®°å½•æ–°è·¯å¾„
    "user_confirmation": True            # éœ€è¦ç”¨æˆ·ç¡®è®¤
}
```

---

**æ–‡æ¡£ç»“æŸ**

*Luna Badge v1.6 - è®©å¯¼èˆªæ›´æ™ºèƒ½ï¼Œè®©è·¯å¾„æ›´çµæ´»*
