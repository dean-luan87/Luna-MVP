# Luna Badge 真实场景测试指南 v2.0

> 覆盖医院导诊 × 日常出行 × 公共交通 × 紧急场景四大类

## 📋 目录

- [测试概述](#测试概述)
- [场景分类](#场景分类)
- [测试用例](#测试用例)
- [执行方法](#执行方法)
- [追踪报告](#追踪报告)
- [问题分析](#问题分析)

---

## 🎯 测试概述

### 目标

验证 Luna Badge 在真实应用场景下的系统联调能力，确保：

- ✅ 各模块正确触发
- ✅ 多模态交互流畅
- ✅ 任务链管理有效
- ✅ 异常处理健壮
- ✅ 日志记录完整

### 覆盖范围

| 场景类别 | 用例数量 | 涉及模块数 | 优先级 |
|---------|---------|-----------|--------|
| A: 医院就诊 | 5 | 6 | P0 |
| B: 日常出行 | 4 | 5 | P0 |
| C: 公共交通 | 3 | 4 | P1 |
| D: 紧急场景 | 4 | 4 | P0 |
| **总计** | **16** | **8** | - |

---

## 🏥 场景 A：医院就诊流程导航

### A1: 初次到医院寻找挂号

**用户行为:**
```
1. "我要挂号"
2. "我没挂过这个医院"
```

**期望系统反应:**
- Whisper 识别语音
- 控制器提示："建议前往咨询台"
- 调用 Navigator 生成路径
- TTS 播报路径
- LogManager 记录行为

**验证点:**
- [ ] Whisper 识别准确
- [ ] Navigator 正确调用
- [ ] TTS 成功播报
- [ ] 日志正确记录
- [ ] Memory 写入路径记忆

**模块依赖:**
```
Whisper → Orchestrator → Navigator → TTS
                           ↓
                       LogManager
                           ↓
                       MemoryStore
```

**预期日志:**
```json
{
  "timestamp": "2025-10-31T12:00:00",
  "source": "voice",
  "intent": "find_registration",
  "content": "我要挂号",
  "system_response": "建议前往咨询台",
  "modules_triggered": ["Whisper", "Navigator", "TTS", "LogManager"]
}
```

---

### A2: 挂号后导航至科室

**用户行为:**
```
"我挂好了牙科"
```

**期望系统反应:**
- ContextStore 记录"牙科"位置
- Navigator 自动识别牙科楼层
- 生成导航路径
- Memory 写入路径记忆

**验证点:**
- [ ] ContextStore 上下文记录正确
- [ ] Navigator 楼层识别准确
- [ ] 导航路径生成成功
- [ ] Memory 记忆持久化

**模块依赖:**
```
ContextStore → Orchestrator → Navigator → Memory
```

**特殊验证:**
- 后续问题"上次那个"能正确解析为"牙科"

---

### A3: 候诊中请求帮助

**用户行为:**
```
"Luna，我听不到叫号"
```

**期望系统反应:**
- 控制器进入语音辅助模式
- 调用 OCR 识别叫号屏幕
- 播报当前叫号信息
- 失败时触发 RetryQueue

**验证点:**
- [ ] 语音辅助模式激活
- [ ] OCR 模块正确调用
- [ ] TTS 播报叫号信息
- [ ] 失败重试机制生效

**模块依赖:**
```
TTS → Orchestrator → OCR → RetryQueue
```

---

### A4: 中途找厕所插入任务

**用户行为:**
```
主任务: 导航到牙科
插入: "我要去厕所"
```

**期望系统反应:**
- TaskInterruptor 暂停主任务
- 插入"查找厕所"子任务
- 完成子任务后提示"是否继续前往牙科？"
- 自动恢复主任务

**验证点:**
- [ ] 主任务正确暂停
- [ ] 子任务成功插入
- [ ] 主任务能正确恢复
- [ ] 上下文未丢失

**模块依赖:**
```
TaskInterruptor → ContextStore → Navigator
```

**任务栈状态:**
```
主任务栈: [去牙科 (PAUSED)]
子任务栈: [找厕所 (ACTIVE)]
```

---

### A5: 遇到台阶/电梯

**用户行为:**
```
摄像头检测: "stairs" 或 "elevator"
```

**期望系统反应:**
- YOLO 检测到台阶/电梯
- Vision 引擎触发事件
- TTS 播报："前方有台阶，请小心"或"电梯在左侧"

**验证点:**
- [ ] YOLO 检测准确
- [ ] Vision 事件正确触发
- [ ] TTS 即时播报
- [ ] 日志记录检测结果

**模块依赖:**
```
Camera → YOLO → Vision → TTS
                      ↓
                  LogManager
```

---

## 🏙️ 场景 B：城市日常出行导航

### B1: 找便利店

**用户行为:**
```
"带我去最近的便利店"
```

**期望系统反应:**
- Whisper 识别
- Navigator 调用地图
- 播报路径
- Memory 写入路径结构
- LogManager 记录行为

**验证点:**
- [ ] 地图调用成功
- [ ] 路径规划合理
- [ ] 播报清晰准确
- [ ] 记忆持久化

---

### B2: 遇到施工

**用户行为:**
```
摄像头检测: "construction" 或 "road_block"
```

**期望系统反应:**
- YOLO 检测围挡
- Vision 触发路径评估
- TTS 播报："前方施工，建议绕行"
- 触发路径重新规划

**验证点:**
- [ ] 施工区域识别
- [ ] 绕行建议播报
- [ ] 路径动态更新

---

### B3: 插入临时任务

**用户行为:**
```
导航途中: "先去买瓶水"
```

**期望系统反应:**
- TaskInterruptor 暂停主任务
- 导航到便利店
- 完成后自动提示"继续之前路线吗？"

**验证点:**
- [ ] 任务打断流畅
- [ ] 临时任务完成
- [ ] 主任务正确恢复

---

### B4: 上下楼定位判断

**用户行为:**
```
摄像头识别楼层标牌: "3F"
```

**期望系统反应:**
- OCR 识别楼层
- 与目标楼层比对
- 更新导航提示

**验证点:**
- [ ] OCR 识别准确
- [ ] 楼层比对正确
- [ ] 导航提示更新

---

## 🚇 场景 C：地铁与公共交通场景

### C1: 地铁站寻找站台

**用户行为:**
```
"我要去浦东机场"
```

**期望系统反应:**
- 查询地铁线路
- 播报应前往站台
- 图像识别站台方向标识确认

**验证点:**
- [ ] 线路查询正确
- [ ] 站台播报准确
- [ ] 方向标识识别

---

### C2: 公交方向错误

**用户行为:**
```
上错方向后: "我上错车了"
```

**期望系统反应:**
- 通过车牌+GPS判断
- 播报"当前方向错误，请下车换乘"

**验证点:**
- [ ] 方向判断准确
- [ ] 提示及时播报

---

### C3: 上下车失败提醒

**用户行为:**
```
刷卡失败，语音无响应
```

**期望系统反应:**
- RetryQueue 记录 pending
- 提醒"是否未进入车站？请确认"
- LogManager 记录异常

**验证点:**
- [ ] 失败缓存生效
- [ ] 重试机制正常
- [ ] 日志记录完整

---

## 🆘 场景 D：紧急情境与多轮交互

### D1: 用户迷路/情绪紧张

**用户行为:**
```
"Luna我有点害怕"
```

**期望系统反应:**
- 切入安抚语音模式
- 播报"别担心，我一直在"
- 记录情绪印象点

**验证点:**
- [ ] 安抚模式激活
- [ ] 语音播报温和
- [ ] 情绪记录持久

---

### D2: 无意义语音

**用户行为:**
```
1. "啊啊啊"
2. "我不知道去哪"
```

**期望系统反应:**
- 识别为情绪激烈或迷茫
- 播报"我可以帮你找最近的工作人员"

**验证点:**
- [ ] 意图判断正确
- [ ] 引导播报合适

---

### D3: 重复请求

**用户行为:**
```
"我要去厕所" × 3
```

**期望系统反应:**
- 触发容错机制
- 不重复播报
- 日志标记用户可能焦虑

**验证点:**
- [ ] 防重播报生效
- [ ] 日志标记正确

---

### D4: 网络中断

**用户行为:**
```
执行任务中突然离线
```

**期望系统反应:**
- 任务标记为"pending"
- 重连后自动恢复
- 补播遗漏信息

**验证点:**
- [ ] 任务缓存正确
- [ ] 恢复机制正常
- [ ] 信息补播完整

---

## 🔬 特别机制验证

### 上下文记忆

**测试场景:** A2

**验证方法:**
1. 执行 "我挂好了牙科"
2. 后续提问 "上次那个"
3. 检查是否解析为 "牙科"

**预期:** ContextStore 正确关联上下文

---

### 插入任务后恢复

**测试场景:** A4, B3

**验证方法:**
1. 启动主任务
2. 插入子任务
3. 完成子任务
4. 检查主任务恢复

**预期:** 主任务完整恢复，上下文不丢失

---

### TTS 失败重播

**测试场景:** D4

**验证方法:**
1. 模拟 TTS 失败
2. 检查 RetryQueue
3. 验证补播

**预期:** 失败任务入队，重试成功

---

### 重复请求容错

**测试场景:** D3

**验证方法:**
1. 发送重复请求
2. 检查日志标记
3. 验证防重播报

**预期:** 不重复播报，日志标记焦虑

---

### 行为日志完整性

**测试场景:** 全部用例

**验证方法:**
1. 检查 logs/user_behavior/
2. 验证每个步骤都有日志
3. 确认日志结构完整

**预期:** 100% 步骤有日志记录

---

## 📊 追踪报告格式

### 测试执行追踪表

| 用例ID | 场景 | 状态 | 耗时 | 触发模块 | 缺失模块 | 错误信息 |
|-------|------|------|------|---------|---------|---------|
| A1 | 医院 | ✅ | 1200ms | Whisper, Navigator, TTS | - | - |
| A2 | 医院 | ✅ | 800ms | ContextStore, Navigator | Memory | - |

### 问题分析报告

```json
{
  "case_id": "A1",
  "status": "FAIL",
  "errors": [
    {
      "module": "TTS",
      "error": "语音播报失败",
      "cause": "音频设备未初始化",
      "suggestion": "检查音频设备状态"
    }
  ],
  "missing_modules": [],
  "partially_working": ["Navigator"]
}
```

---

## 🚀 执行方法

### 快速执行

```bash
# 执行所有测试场景
cd Luna_Badge
python3 test_real_scenarios.py

# 查看报告
cat test_reports/report_*.json | jq
```

### 单独执行场景

```python
# 执行场景A（医院）
suite = RealScenarioTestSuite()
suite.execute_scenario("A")

# 执行单个用例
suite.execute_case("A1")
```

---

## 📈 成功标准

| 指标 | 目标值 | 权重 |
|-----|-------|------|
| 总成功率 | ≥ 90% | 40% |
| P0场景通过率 | ≥ 95% | 30% |
| 模块触发完整性 | 100% | 20% |
| 日志记录率 | 100% | 10% |

**综合评分:** ≥ 90 分 → 生产就绪

---

## 🐛 问题处理

### 常见问题

1. **模块未触发**
   - 检查模块是否初始化
   - 验证事件路由配置
   - 查看日志

2. **TTS播报失败**
   - 检查音频设备
   - 验证 TTS 引擎状态
   - 查看 RetryQueue

3. **上下文丢失**
   - 检查 ContextStore 配置
   - 验证任务栈状态
   - 查看日志

4. **重试不生效**
   - 检查 RetryQueue 配置
   - 验证回调注册
   - 查看重试日志

---

## ✅ 完成检查清单

- [ ] 所有测试用例执行完成
- [ ] 追踪报告生成
- [ ] 问题分析完成
- [ ] 修复验证通过
- [ ] 文档更新完成

---

**版本:** v2.0  
**更新时间:** 2025-10-31  
**维护者:** Luna Badge Team

