# Luna è·¨è®¾å¤‡è®°å¿†åŒæ­¥æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

æ”¯æŒç”¨æˆ·åœ¨åˆ‡æ¢è®¾å¤‡æ—¶ï¼Œé€šè¿‡ç™»å½•è´¦å·ä¸‹è½½å¹¶æ¢å¤æ‰€æœ‰åœ°å›¾è®°å¿†å’Œå¯¼èˆªæ•°æ®ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
3. [äº‘ç«¯å­˜å‚¨æ–¹æ¡ˆ](#äº‘ç«¯å­˜å‚¨æ–¹æ¡ˆ)
4. [åŒæ­¥æµç¨‹](#åŒæ­¥æµç¨‹)
5. [å®ç°ç¤ºä¾‹](#å®ç°ç¤ºä¾‹)

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾å¤‡A (Mac)    â”‚  â”€â”€â”€â”€â–º  â”‚   äº‘ç«¯å­˜å‚¨æœåŠ¡    â”‚  â”€â”€â”€â”€â–º  â”‚ è®¾å¤‡B (RV1126)  â”‚
â”‚                â”‚         â”‚                  â”‚         â”‚                â”‚
â”‚ - åœ°å›¾ç”Ÿæˆ      â”‚         â”‚ - ç”¨æˆ·è´¦å·ç®¡ç†    â”‚         â”‚ - åœ°å›¾ä¸‹è½½      â”‚
â”‚ - æ•°æ®ä¸Šä¼       â”‚         â”‚ - è®°å¿†æ•°æ®å­˜å‚¨    â”‚         â”‚ - æ•°æ®æ¢å¤      â”‚
â”‚ - è·¯å¾„è®°å½•      â”‚         â”‚ - ç‰ˆæœ¬æ§åˆ¶        â”‚         â”‚ - å¯¼èˆªä½¿ç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                           â–²                                â–²
      â”‚                           â”‚                                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·è´¦å·ç™»å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æ¨¡å‹

### ç”¨æˆ·è´¦å·æ•°æ®ç»“æ„

```json
{
  "user_id": "user_123456",
  "username": "å¼ ä¸‰",
  "created_at": "2025-10-01T10:00:00",
  "devices": [
    {
      "device_id": "mac_001",
      "device_name": "MacBook Pro",
      "last_sync": "2025-10-30T17:30:00"
    },
    {
      "device_id": "rv1126_001",
      "device_name": "Luna Badge",
      "last_sync": "2025-10-30T16:00:00"
    }
  ]
}
```

### åœ°å›¾è®°å¿†æ•°æ®ç»“æ„

```json
{
  "user_id": "user_123456",
  "maps": [
    {
      "map_id": "hospital_main_enhanced",
      "path_id": "hospital_main_enhanced",
      "version": "1.0",
      "created_at": "2025-10-30T16:29:28",
      "last_modified": "2025-10-30T16:29:28",
      "data": {
        "path_name": "åŒ»é™¢å®Œæ•´å¯¼èˆªè·¯å¾„",
        "nodes": [...],
        "regions": [...],
        "metadata": {...}
      },
      "files": {
        "image": "hospital_main_enhanced_emotional.png",
        "metadata": "hospital_main_enhanced_emotional.meta.json"
      }
    }
  ],
  "total_maps": 1,
  "storage_used": "2.5MB"
}
```

### åœºæ™¯è®°å¿†æ•°æ®ç»“æ„

```json
{
  "user_id": "user_123456",
  "scenes": [
    {
      "scene_id": "scene_001",
      "location": "è™¹å£åŒ»é™¢",
      "captured_at": "2025-10-30T10:00:00",
      "images": [
        "scene_images/scene_001_1.jpg",
        "scene_images/scene_001_2.jpg"
      ],
      "annotations": {
        "doorplate": "å†…åˆ†æ³Œç§‘",
        "landmarks": ["ç”µæ¢¯", "å«ç”Ÿé—´"],
        "emotions": ["å®‰é™"]
      }
    }
  ],
  "total_scenes": 5
}
```

### ç”¨æˆ·åå¥½æ•°æ®ç»“æ„

```json
{
  "user_id": "user_123456",
  "preferences": {
    "navigation": {
      "prefer_walk": true,
      "avoid_transfer": false,
      "voice_speed": "normal",
      "notification_level": "normal"
    },
    "memory": {
      "auto_save": true,
      "cloud_sync": true,
      "retention_days": 30
    }
  },
  "family_faces": [
    {
      "face_id": "face_001",
      "label": "å¦ˆå¦ˆ",
      "relationship": "mother"
    }
  ]
}
```

---

## äº‘ç«¯å­˜å‚¨æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šåŸºäºäº‘å­˜å‚¨æœåŠ¡ï¼ˆæ¨èï¼‰

#### AWS S3 / é˜¿é‡Œäº‘OSS

```python
import boto3
from pathlib import Path

class CloudMapStorage:
    """äº‘ç«¯åœ°å›¾å­˜å‚¨"""
    
    def __init__(self, user_id: str):
        self.user_id = user_id
        self.bucket_name = "luna-user-maps"
        self.s3_client = boto3.client('s3')
    
    def upload_map(self, map_data: dict, map_files: dict):
        """ä¸Šä¼ åœ°å›¾æ•°æ®"""
        # ä¸Šä¼ JSONæ•°æ®
        json_key = f"{self.user_id}/maps/{map_data['map_id']}/data.json"
        self.s3_client.put_object(
            Bucket=self.bucket_name,
            Key=json_key,
            Body=json.dumps(map_data, ensure_ascii=False)
        )
        
        # ä¸Šä¼ PNGå›¾åƒ
        if "image" in map_files:
            image_key = f"{self.user_id}/maps/{map_data['map_id']}/map.png"
            self.s3_client.upload_file(
                map_files["image"],
                self.bucket_name,
                image_key
            )
        
        return True
    
    def download_map(self, map_id: str, local_dir: str):
        """ä¸‹è½½åœ°å›¾æ•°æ®"""
        map_dir = Path(local_dir)
        map_dir.mkdir(parents=True, exist_ok=True)
        
        # ä¸‹è½½JSON
        json_key = f"{self.user_id}/maps/{map_id}/data.json"
        self.s3_client.download_file(
            self.bucket_name,
            json_key,
            str(map_dir / f"{map_id}.json")
        )
        
        # ä¸‹è½½PNG
        image_key = f"{self.user_id}/maps/{map_id}/map.png"
        self.s3_client.download_file(
            self.bucket_name,
            image_key,
            str(map_dir / f"{map_id}.png")
        )
        
        return True
    
    def list_user_maps(self):
        """åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰åœ°å›¾"""
        prefix = f"{self.user_id}/maps/"
        response = self.s3_client.list_objects_v2(
            Bucket=self.bucket_name,
            Prefix=prefix
        )
        
        maps = []
        for obj in response.get('Contents', []):
            if obj['Key'].endswith('/data.json'):
                map_id = obj['Key'].split('/')[-2]
                maps.append(map_id)
        
        return maps
```

#### æ–‡ä»¶ç»“æ„

```
luna-user-maps/
â”œâ”€â”€ user_123456/
â”‚   â”œâ”€â”€ maps/
â”‚   â”‚   â”œâ”€â”€ hospital_main_enhanced/
â”‚   â”‚   â”‚   â”œâ”€â”€ data.json
â”‚   â”‚   â”‚   â”œâ”€â”€ map.png
â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”‚   â””â”€â”€ mall_navigation/
â”‚   â”‚       â”œâ”€â”€ data.json
â”‚   â”‚       â”œâ”€â”€ map.png
â”‚   â”‚       â””â”€â”€ metadata.json
â”‚   â”œâ”€â”€ scenes/
â”‚   â”‚   â”œâ”€â”€ scene_001/
â”‚   â”‚   â”‚   â”œâ”€â”€ image1.jpg
â”‚   â”‚   â”‚   â”œâ”€â”€ image2.jpg
â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”œâ”€â”€ preferences.json
â”‚   â””â”€â”€ devices.json
```

---

## åŒæ­¥æµç¨‹

### 1. é¦–æ¬¡ä¸Šä¼ ï¼ˆè®¾å¤‡Aï¼‰

```python
def sync_maps_to_cloud(user_id: str, local_map_dir: str):
    """å°†æœ¬åœ°åœ°å›¾åŒæ­¥åˆ°äº‘ç«¯"""
    loader = LunaMapLoader(local_map_dir)
    storage = CloudMapStorage(user_id)
    
    # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åœ°å›¾
    local_maps = loader.list_available_maps()
    
    sync_results = []
    for map_id in local_maps:
        # åŠ è½½åœ°å›¾æ•°æ®
        map_card = loader.load_map_card(map_id)
        
        if not map_card:
            continue
        
        # ä¸Šä¼ åˆ°äº‘ç«¯
        result = storage.upload_map(
            map_data=map_card["metadata"],
            map_files={
                "image": map_card["image"]
            }
        )
        
        sync_results.append({
            "map_id": map_id,
            "status": "success" if result else "failed"
        })
    
    return sync_results
```

### 2. æ–°è®¾å¤‡ä¸‹è½½ï¼ˆè®¾å¤‡Bï¼‰

```python
def sync_maps_from_cloud(user_id: str, local_map_dir: str):
    """ä»äº‘ç«¯ä¸‹è½½åœ°å›¾åˆ°æœ¬åœ°"""
    storage = CloudMapStorage(user_id)
    loader = LunaMapLoader(local_map_dir)
    
    # åˆ—å‡ºäº‘ç«¯æ‰€æœ‰åœ°å›¾
    cloud_maps = storage.list_user_maps()
    
    download_results = []
    for map_id in cloud_maps:
        # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨
        if map_id in loader.list_available_maps():
            logger.info(f"åœ°å›¾å·²å­˜åœ¨ï¼š{map_id}ï¼Œè·³è¿‡")
            continue
        
        # ä¸‹è½½åœ°å›¾
        result = storage.download_map(map_id, local_map_dir)
        
        download_results.append({
            "map_id": map_id,
            "status": "success" if result else "failed"
        })
    
    return download_results
```

### 3. å¢é‡åŒæ­¥

```python
def incremental_sync(user_id: str, local_map_dir: str):
    """å¢é‡åŒæ­¥ï¼ˆåªåŒæ­¥æ›´æ–°çš„åœ°å›¾ï¼‰"""
    loader = LunaMapLoader(local_map_dir)
    storage = CloudMapStorage(user_id)
    
    # è·å–äº‘ç«¯åœ°å›¾å…ƒä¿¡æ¯
    cloud_maps_info = storage.get_maps_metadata(user_id)
    
    # è·å–æœ¬åœ°åœ°å›¾ä¿¡æ¯
    local_maps_info = loader.list_available_maps_with_metadata()
    
    # æ¯”è¾ƒå¹¶å†³å®šåŒæ­¥æ–¹å‘
    sync_actions = []
    
    for cloud_map in cloud_maps_info:
        map_id = cloud_map["map_id"]
        local_map = local_maps_info.get(map_id)
        
        if not local_map:
            # äº‘ç«¯æœ‰ï¼Œæœ¬åœ°æ²¡æœ‰ -> ä¸‹è½½
            sync_actions.append({
                "action": "download",
                "map_id": map_id
            })
        elif cloud_map["last_modified"] > local_map["last_modified"]:
            # äº‘ç«¯æ›´æ–° -> ä¸‹è½½
            sync_actions.append({
                "action": "download",
                "map_id": map_id
            })
    
    for local_map in local_maps_info.values():
        map_id = local_map["map_id"]
        if map_id not in cloud_maps_info:
            # æœ¬åœ°æœ‰ï¼Œäº‘ç«¯æ²¡æœ‰ -> ä¸Šä¼ 
            sync_actions.append({
                "action": "upload",
                "map_id": map_id
            })
    
    # æ‰§è¡ŒåŒæ­¥
    for action in sync_actions:
        if action["action"] == "download":
            storage.download_map(action["map_id"], local_map_dir)
        else:
            map_card = loader.load_map_card(action["map_id"])
            storage.upload_map(map_card["metadata"], map_card)
    
    return sync_actions
```

---

## å®ç°ç¤ºä¾‹

### å®Œæ•´åŒæ­¥ç®¡ç†å™¨

```python
import json
import os
from datetime import datetime
from pathlib import Path

class LunaCloudSync:
    """Luna äº‘ç«¯åŒæ­¥ç®¡ç†å™¨"""
    
    def __init__(self, user_id: str, api_key: str):
        self.user_id = user_id
        self.api_key = api_key
        self.cloud_storage = CloudMapStorage(user_id)
        self.local_loader = LunaMapLoader()
    
    def login(self, username: str, password: str) -> bool:
        """ç™»å½•è´¦å·"""
        # è°ƒç”¨ç™»å½•API
        auth_result = self._authenticate(username, password)
        
        if auth_result:
            # ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            self._save_user_info(auth_result)
            self.user_id = auth_result["user_id"]
            return True
        
        return False
    
    def sync_all_maps(self) -> dict:
        """åŒæ­¥æ‰€æœ‰åœ°å›¾"""
        logger.info(f"ğŸ”„ å¼€å§‹åŒæ­¥åœ°å›¾ï¼šç”¨æˆ· {self.user_id}")
        
        # å¢é‡åŒæ­¥
        sync_actions = incremental_sync(self.user_id, "data/map_cards")
        
        # ç»Ÿè®¡
        stats = {
            "downloaded": 0,
            "uploaded": 0,
            "skipped": 0
        }
        
        for action in sync_actions:
            if action["action"] == "download":
                stats["downloaded"] += 1
            elif action["action"] == "upload":
                stats["uploaded"] += 1
            elif action["action"] == "skip":
                stats["skipped"] += 1
        
        logger.info(f"âœ… åŒæ­¥å®Œæˆï¼šä¸‹è½½{stats['downloaded']}ä¸ªï¼Œä¸Šä¼ {stats['uploaded']}ä¸ªï¼Œè·³è¿‡{stats['skipped']}ä¸ª")
        
        return stats
    
    def backup_all_data(self, backup_path: str):
        """å¤‡ä»½æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºæ‰‹åŠ¨å¤‡ä»½ï¼‰"""
        backup_dir = Path(backup_path)
        backup_dir.mkdir(parents=True, exist_ok=True)
        
        # å¤‡ä»½åœ°å›¾
        maps_backup = backup_dir / "maps"
        maps_backup.mkdir(exist_ok=True)
        # ...å¤åˆ¶åœ°å›¾æ–‡ä»¶
        
        # å¤‡ä»½åœºæ™¯è®°å¿†
        scenes_backup = backup_dir / "scenes"
        scenes_backup.mkdir(exist_ok=True)
        # ...å¤åˆ¶åœºæ™¯æ–‡ä»¶
        
        # å¤‡ä»½ç”¨æˆ·åå¥½
        with open(backup_dir / "preferences.json", 'w') as f:
            json.dump(self._load_preferences(), f)
        
        logger.info(f"âœ… å¤‡ä»½å®Œæˆï¼š{backup_path}")
    
    def restore_from_backup(self, backup_path: str):
        """ä»å¤‡ä»½æ¢å¤æ•°æ®"""
        backup_dir = Path(backup_path)
        
        # æ¢å¤åœ°å›¾
        # ...
        
        # æ¢å¤åœºæ™¯è®°å¿†
        # ...
        
        # æ¢å¤ç”¨æˆ·åå¥½
        # ...
        
        logger.info(f"âœ… æ¢å¤å®Œæˆï¼šä» {backup_path}")
    
    def get_sync_status(self) -> dict:
        """è·å–åŒæ­¥çŠ¶æ€"""
        return {
            "last_sync": self._get_last_sync_time(),
            "total_maps_cloud": len(self.cloud_storage.list_user_maps()),
            "total_maps_local": len(self.local_loader.list_available_maps()),
            "last_device": self._get_last_device()
        }
```

---

## ä½¿ç”¨æµç¨‹

### åœºæ™¯1ï¼šæ–°è®¾å¤‡åˆå§‹åŒ–

```python
# 1. ç™»å½•è´¦å·
sync_manager = LunaCloudSync(None, None)
if sync_manager.login("å¼ ä¸‰", "password"):
    print("âœ… ç™»å½•æˆåŠŸ")
    
    # 2. ä¸‹è½½æ‰€æœ‰åœ°å›¾
    sync_stats = sync_manager.sync_all_maps()
    
    # 3. éªŒè¯åœ°å›¾
    loader = LunaMapLoader()
    downloaded_maps = loader.list_available_maps()
    print(f"ğŸ“¥ å·²ä¸‹è½½{len(downloaded_maps)}ä¸ªåœ°å›¾")
```

### åœºæ™¯2ï¼šæ—¥å¸¸åŒæ­¥

```python
# å®šæœŸåŒæ­¥ï¼ˆä¾‹å¦‚ï¼šæ¯å°æ—¶ï¼‰
def periodic_sync():
    sync_manager = LunaCloudSync(user_id, api_key)
    stats = sync_manager.sync_all_maps()
    
    # è®°å½•åŒæ­¥æ—¥å¿—
    sync_manager.log_sync_event(stats)

# è®¾ç½®å®šæ—¶ä»»åŠ¡
schedule.every(1).hours.do(periodic_sync)
```

### åœºæ™¯3ï¼šæ‰‹åŠ¨å¤‡ä»½

```python
# å¯¼å‡ºæ‰€æœ‰æ•°æ®
sync_manager = LunaCloudSync(user_id, api_key)
backup_path = f"backup/{datetime.now().strftime('%Y%m%d_%H%M%S')}"
sync_manager.backup_all_data(backup_path)

# å¯¼å…¥åˆ°æ–°è®¾å¤‡
new_sync_manager = LunaCloudSync(new_user_id, new_api_key)
new_sync_manager.restore_from_backup(backup_path)
```

---

## æ€»ç»“

é€šè¿‡äº‘ç«¯åŒæ­¥æ–¹æ¡ˆï¼Œç”¨æˆ·å¯ä»¥ï¼š

1. âœ… **æ— ç¼åˆ‡æ¢è®¾å¤‡**ï¼šç™»å½•åè‡ªåŠ¨ä¸‹è½½æ‰€æœ‰åœ°å›¾è®°å¿†
2. âœ… **æ•°æ®å®‰å…¨**ï¼šäº‘ç«¯å¤‡ä»½ï¼Œä¸ä¸¢å¤±
3. âœ… **å¢é‡åŒæ­¥**ï¼šåªåŒæ­¥æ›´æ”¹ï¼ŒèŠ‚çœæµé‡
4. âœ… **è·¨å¹³å°ä½¿ç”¨**ï¼šMacã€RV1126ã€äº‘ç«¯éƒ½å¯è®¿é—®
5. âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šè‡ªåŠ¨å¤„ç†å†²çª
6. âœ… **ç¦»çº¿å¤‡ä»½**ï¼šæ”¯æŒæœ¬åœ°å¤‡ä»½å’Œæ¢å¤

**æ ¸å¿ƒä»·å€¼**ï¼šè®°å¿†è·Ÿéšç”¨æˆ·ï¼Œè€Œéè®¾å¤‡ï¼

