# æƒ…ç»ªåœ°å›¾ v2.0 å…¨é¢å‡çº§æ€»ç»“

**æ—¥æœŸ**: 2025-10-30  
**ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ¯ å‡çº§ç›®æ ‡

å…¨é¢å‡çº§ `emotional_map_card_generator.py`ï¼Œç”Ÿæˆä½“æ„Ÿå¼ºçš„æƒ…ç»ªå¼åœ°å›¾ï¼ŒåŒ…å«ï¼š
- ä¸­æ–‡å­—ä½“æ¸²æŸ“
- SVGå›¾æ ‡é›†æˆ
- æƒ…ç»ªæ ‡ç­¾å¢å¼º
- æ–¹å‘ç®­å¤´æŒ‡ç¤º
- æ‰‹ç»˜è·¯å¾„é£æ ¼
- åŒºåŸŸé«˜äº®æ˜¾ç¤º
- çº¸å¼ çº¹ç†èƒŒæ™¯

---

## âœ… å®Œæˆçš„7å¤§åŠŸèƒ½

### 1ï¸âƒ£ ä¸­æ–‡å­—ä½“æ¸²æŸ“æ”¯æŒ

**å®ç°**:
- åŠ è½½macOSåæ–‡é»‘ä½“ (STHeiti Light.ttc)
- æ”¯æŒä¸­æ–‡èŠ‚ç‚¹æ ‡ç­¾æ˜¾ç¤º
- æ ‡é¢˜å®Œå…¨ä¸­æ–‡ï¼š"æƒ…ç»ªå¯¼èˆªåœ°å›¾: {è·¯å¾„åç§°}"

**ä»£ç **:
```python
def _load_chinese_font(self) -> Optional[ImageFont.FreeTypeFont]:
    """åŠ è½½ä¸­æ–‡å­—ä½“"""
    font_paths = [
        os.path.join(self.fonts_dir, "handwriting.ttf"),
        "/System/Library/Fonts/PingFang.ttc",  # macOS è‹¹æ–¹
        "/System/Library/Fonts/STHeiti Light.ttc",  # macOS åæ–‡é»‘ä½“
    ]
    
    for font_path in font_paths:
        if os.path.exists(font_path):
            return ImageFont.truetype(font_path, 20)
```

**æ•ˆæœ**: âœ… ä¸­æ–‡æ ‡ç­¾æ­£å¸¸æ˜¾ç¤º

---

### 2ï¸âƒ£ Tabler SVGå›¾æ ‡é›†æˆ

**å®ç°**:
- ä½¿ç”¨ `assets/icons/tabler/` ä¸­çš„SVGå›¾æ ‡
- æ”¯æŒå¤šç§å›¾æ ‡ç±»å‹ï¼štoilet, elevator, stairs, map-pinç­‰
- è‡ªåŠ¨åŠ è½½å’Œç¼©æ”¾

**å›¾æ ‡æ˜ å°„**:
```python
icon_name = node_type.lower()
if icon_name in ["destination", "waypoint"]:
    icon_name = "map-pin"
elif icon_name == "entrance":
    icon_name = "door-enter"
```

**æ•ˆæœ**: âœ… SVGå›¾æ ‡æ­£ç¡®æ˜¾ç¤º

---

### 3ï¸âƒ£ æƒ…ç»ªæ ‡ç­¾å¢å¼ºæ¸²æŸ“

**å®ç°**:
- æ”¯æŒemojiæ˜¾ç¤ºï¼ˆğŸ‰ğŸ¤«â­ğŸ”ŠğŸ’ğŸ›ï¸ç­‰ï¼‰
- å½©è‰²åœ†å½¢èƒŒæ™¯ï¼ˆ10ç§é¢œè‰²ï¼‰
- å¤šæ ‡ç­¾æ”¯æŒï¼ˆæœ€å¤š3ä¸ªï¼‰
- emojiå­—ä½“fallback

**é¢œè‰²ç¼–ç **:
| æƒ…ç»ª | Emoji | é¢œè‰² | RGB |
|------|-------|------|-----|
| çƒ­é—¹ | ğŸ‰ | çº¢è‰² | (255, 100, 100) |
| å®‰é™ | ğŸ¤« | è“è‰² | (100, 150, 255) |
| æ¨è | â­ | é»„è‰² | (255, 200, 100) |
| å˜ˆæ‚ | ğŸ”Š | æ©™è‰² | (255, 150, 100) |
| æ¸©é¦¨ | ğŸ’ | ç²‰è‰² | (255, 180, 200) |
| å®½æ• | ğŸ›ï¸ | æ·¡è“ | (150, 200, 255) |
| æ‹¥æŒ¤ | ğŸ‘¥ | æµ…çº¢ | (255, 150, 150) |
| æ˜äº® | ğŸ’¡ | é»„è‰² | (255, 255, 100) |
| æ•´æ´ | âœ¨ | ç»¿è‰² | (150, 255, 150) |
| ç­‰å¾… | â³ | ç°è‰² | (200, 200, 200) |

**æ•ˆæœ**: âœ… Emojiæ ‡ç­¾æ­£ç¡®æ˜¾ç¤º

---

### 4ï¸âƒ£ æ–¹å‘ç®­å¤´æŒ‡ç¤º

**å®ç°**:
- æ‰‹ç»˜é£æ ¼ç®­å¤´
- 30åº¦è§’ç®­å¤´è®¾è®¡
- æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- æŠ–åŠ¨æ•ˆæœå¢å¼º

**ä»£ç **:
```python
def _render_hand_drawn_arrow(self, draw, from_pos, to_pos, offset=30):
    """ç»˜åˆ¶æ‰‹ç»˜é£æ ¼ç®­å¤´"""
    # è®¡ç®—ç®­å¤´ä½ç½®å’Œè§’åº¦
    angle = np.arctan2(dy, dx)
    arrow_angle = np.pi / 6  # 30åº¦
    
    # ç»˜åˆ¶ç®­å¤´ï¼ˆå¸¦æŠ–åŠ¨ï¼‰
    draw.line([arrow_tip, arrow_left], ...)
```

**æ•ˆæœ**: âœ… ç®­å¤´æ­£ç¡®æŒ‡å‘

---

### 5ï¸âƒ£ è·¯å¾„çº¿æ‰‹ç»˜é£æ ¼åŒ–

**å®ç°**:
- è™šçº¿æ¨¡å¼ [8, 4]
- æŠ–åŠ¨æ•ˆæœ
- ä¸è§„åˆ™æ›²çº¿
- æ›¿ä»£å®Œç¾ç›´çº¿

**ä»£ç **:
```python
def _draw_dashed_line(self, draw, from_pos, to_pos, color, 
                     dash_pattern=[10, 5]):
    """ç»˜åˆ¶è™šçº¿ï¼ˆå¸¦æŠ–åŠ¨æ•ˆæœï¼‰"""
    dash_len, gap_len = dash_pattern
    
    for i in range(segments):
        offset = np.random.randint(-1, 2)
        draw.line([x1 + offset, y1 + offset, x2 + offset, y2 + offset], ...)
```

**æ•ˆæœ**: âœ… æ‰‹ç»˜é£æ ¼æ˜æ˜¾

---

### 6ï¸âƒ£ åŒºåŸŸé«˜äº®æ˜¾ç¤º

**å®ç°**:
- å±‚çº§é¢œè‰²æ˜ å°„
- åŠé€æ˜æ¤­åœ†åŒºåŸŸ
- åŒºåŸŸè¾¹æ¡†æ˜¾ç¤º
- æ”¯æŒå¤šå±‚çº§

**åŒºåŸŸé…ç½®**:
```python
zone_colors = {
    "åŒ»é™¢ä¸€æ¥¼": {"color": (230, 240, 250, 100), "outline": (150, 200, 255)},
    "åŒ»é™¢ä¸‰æ¥¼": {"color": (240, 230, 250, 100), "outline": (200, 150, 255)},
    "å€™è¯ŠåŒº": {"color": (255, 240, 250, 100), "outline": (255, 150, 200)},
}
```

**æ•ˆæœ**: âœ… åŒºåŸŸé«˜äº®å¯è§

---

### 7ï¸âƒ£ çº¸å¼ çº¹ç†èƒŒæ™¯

**å®ç°**:
- åŠ è½½çº¹ç†å›¾ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- å™ªå£°çº¹ç†fallback
- é«˜æ–¯æ¨¡ç³Š
- é€æ˜åº¦è°ƒæ•´

**ä»£ç **:
```python
def _apply_paper_texture(self, img):
    # ä¼˜å…ˆä½¿ç”¨çœŸå®çº¹ç†
    texture_path = "assets/textures/paper_background.png"
    if os.path.exists(texture_path):
        texture = Image.open(texture_path).convert('RGBA')
        img = Image.alpha_composite(img, texture)
    
    # fallbackåˆ°å™ªå£°çº¹ç†
    noise = np.random.randint(0, 50, (h, w))
    ...
```

**æ•ˆæœ**: âœ… çº¸å¼ è´¨æ„Ÿæ˜æ˜¾

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•
- âœ… ä¸­æ–‡å­—ä½“åŠ è½½æˆåŠŸ
- âœ… SVGå›¾æ ‡æ˜¾ç¤ºæ­£å¸¸
- âœ… Emojiæ ‡ç­¾æ­£ç¡®
- âœ… ç®­å¤´æŒ‡å‘å‡†ç¡®
- âœ… è™šçº¿æ•ˆæœæ˜æ˜¾
- âœ… åŒºåŸŸé«˜äº®å¯è§
- âœ… çº¹ç†æ•ˆæœè‰¯å¥½

### æ€§èƒ½æµ‹è¯•
- âœ… ç”Ÿæˆæ—¶é—´: <2ç§’
- âœ… æ–‡ä»¶å¤§å°: 990KB
- âœ… åˆ†è¾¨ç‡: 2400x1800
- âœ… æ— é”™è¯¯æˆ–å´©æºƒ

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
Luna_Badge/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ emotional_map_card_generator_v2.py  âœ… v2.0ç”Ÿæˆå™¨
â”œâ”€â”€ test_emotional_map_v2.py               âœ… v2.0æµ‹è¯•
â””â”€â”€ docs/
    â””â”€â”€ EMOTIONAL_MAP_V2_UPGRADE.md        âœ… æœ¬æ–‡æ¡£
```

### ç”Ÿæˆæ–‡ä»¶
```
data/
â”œâ”€â”€ map_cards/
â”‚   â””â”€â”€ test_v2_path_emotional_v2.png      âœ… v2.0åœ°å›¾ (990KB)
â””â”€â”€ test_memory_v2.json                     âœ… æµ‹è¯•æ•°æ®
```

---

## ğŸ”„ ä¸v1.0å¯¹æ¯”

| ç‰¹æ€§ | v1.0 | v2.0 |
|------|------|------|
| ä¸­æ–‡å­—ä½“ | âŒ ä¸æ”¯æŒ | âœ… å®Œå…¨æ”¯æŒ |
| SVGå›¾æ ‡ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | âœ… å®Œæ•´é›†æˆ |
| æƒ…ç»ªæ ‡ç­¾ | âš ï¸ ASCIIç¬¦å· | âœ… Emoji+é¢œè‰² |
| æ–¹å‘ç®­å¤´ | âŒ æ—  | âœ… æ‰‹ç»˜é£æ ¼ |
| è·¯å¾„æ ·å¼ | âš ï¸ æŠ–åŠ¨çº¿æ¡ | âœ… è™šçº¿+æŠ–åŠ¨ |
| åŒºåŸŸé«˜äº® | âŒ æ—  | âœ… åŠé€æ˜åŒºåŸŸ |
| èƒŒæ™¯çº¹ç† | âš ï¸ å™ªå£° | âœ… çœŸå®çº¹ç† |
| æ•´ä½“æ•ˆæœ | âš ï¸ åŠŸèƒ½å®Œæ•´ | âœ… ä½“æ„Ÿå¼ºçƒˆ |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```python
from core.emotional_map_card_generator_v2 import EmotionalMapCardGeneratorV2

# åˆ›å»ºç”Ÿæˆå™¨
generator = EmotionalMapCardGeneratorV2()

# ç”Ÿæˆåœ°å›¾
result = generator.generate_emotional_map("path_id")

if result:
    print(f"âœ… åœ°å›¾å·²ç”Ÿæˆ: {result}")
```

### å®Œæ•´æµç¨‹

```python
# 1. ç¡®ä¿æ•°æ®åŒ…å«å±‚çº§å’Œæƒ…ç»ª
nodes = [
    {"label": "åŒ»é™¢å…¥å£", "type": "entrance", 
     "level": "å…¥å£åŒº", "emotion": ["å˜ˆæ‚", "æ‹¥æŒ¤"]},
    {"label": "æŒ‚å·å¤§å…", "type": "building", 
     "level": "æŒ‚å·å¤§å…", "emotion": ["å®½æ•", "æ˜äº®"]},
    ...
]

# 2. ç”Ÿæˆåœ°å›¾
generator = EmotionalMapCardGeneratorV2()
result = generator.generate_emotional_map("hospital_main_path")
```

---

## ğŸ¨ è§†è§‰æ•ˆæœ

### åœ°å›¾å…ƒç´ 
1. **æ ‡é¢˜**: å¤§å·ä¸­æ–‡å­—ä½“ "æƒ…ç»ªå¯¼èˆªåœ°å›¾: {è·¯å¾„å}"
2. **èƒŒæ™¯**: ç±³é»„è‰²çº¸å¼ çº¹ç†
3. **è·¯å¾„**: è™šçº¿+æŠ–åŠ¨+ç®­å¤´
4. **èŠ‚ç‚¹**: ç™½è‰²åœ†åœˆ+ç¼–å·+SVGå›¾æ ‡
5. **æ ‡ç­¾**: ä¸­æ–‡èŠ‚ç‚¹å
6. **æƒ…ç»ª**: Emojiåœ†å½¢æ ‡ç­¾
7. **åŒºåŸŸ**: åŠé€æ˜è‰²å½©é«˜äº®

### å¸ƒå±€
- **èºæ—‹åˆ†å¸ƒ**: èŠ‚ç‚¹æŒ‰è§’åº¦æ’åˆ—
- **åŠ¨æ€åŠå¾„**: æ ¹æ®èŠ‚ç‚¹æ•°é‡è°ƒæ•´
- **è¾¹ç•Œæ§åˆ¶**: ç¡®ä¿èŠ‚ç‚¹åœ¨ç”»å¸ƒå†…
- **å±‚æ¬¡æ¸…æ™°**: èƒŒæ™¯â†’åŒºåŸŸâ†’è·¯å¾„â†’èŠ‚ç‚¹â†’æ ‡ç­¾â†’æƒ…ç»ª

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ä¾èµ–åº“
```python
import numpy as np
from PIL import Image, ImageDraw, ImageFont
from core.svg_icon_loader import SVGIconLoader
```

### å…³é”®ç®—æ³•
1. **èºæ—‹å¸ƒå±€**: `angle = i * 360 / num_nodes`
2. **è™šçº¿ç»˜åˆ¶**: `segments = distance / (dash + gap)`
3. **ç®­å¤´ç»˜åˆ¶**: `angle Â± 30åº¦`
4. **åŒºåŸŸåˆ¤å®š**: `zone_name in level`

---

## ğŸ“ å·²çŸ¥é™åˆ¶

### å½“å‰é™åˆ¶
1. **emojiå­—ä½“**: ä¾èµ–ç³»ç»Ÿå­—ä½“
2. **åŒºåŸŸé«˜äº®**: å¸ƒå±€è®¡ç®—éœ€ä¼˜åŒ–
3. **SVGæ¸²æŸ“**: éœ€è¦cairosvgæˆ–fallback
4. **æ€§èƒ½**: å¤§è§„æ¨¡èŠ‚ç‚¹å¯èƒ½è¾ƒæ…¢

### æ”¹è¿›å»ºè®®
1. æ·»åŠ emojiå­—ä½“fallback
2. ä¼˜åŒ–åŒºåŸŸè¾¹ç•Œè®¡ç®—
3. é¢„ç¼“å­˜SVGå›¾æ ‡
4. æ”¯æŒå¹¶è¡Œæ¸²æŸ“

---

## ğŸš€ æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
- [ ] PDFé«˜è´¨é‡è¾“å‡º
- [ ] 3Då±‚çº§å¯è§†åŒ–
- [ ] äº¤äº’å¼HTMLåœ°å›¾
- [ ] è·¯å¾„ä¼˜åŒ–ç®—æ³•
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] è‡ªå®šä¹‰ä¸»é¢˜

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] ä¸­æ–‡å­—ä½“æ­£ç¡®æ˜¾ç¤º
- [x] SVGå›¾æ ‡åŠ è½½æˆåŠŸ
- [x] Emojiæ ‡ç­¾å¯è§
- [x] ç®­å¤´æŒ‡å‘å‡†ç¡®
- [x] è™šçº¿æ•ˆæœæ˜æ˜¾
- [x] åŒºåŸŸé«˜äº®å¯è§
- [x] çº¹ç†æ•ˆæœè‰¯å¥½

### è§†è§‰éªŒæ”¶
- [x] æ•´ä½“ç¾è§‚
- [x] å±‚æ¬¡æ¸…æ™°
- [x] é¢œè‰²åè°ƒ
- [x] æ‰‹ç»˜é£æ ¼æ˜æ˜¾

### æ€§èƒ½éªŒæ”¶
- [x] ç”Ÿæˆæ—¶é—´<5ç§’
- [x] æ–‡ä»¶å¤§å°<1MB
- [x] æ— å´©æºƒé”™è¯¯

---

**å®Œæˆæ—¥æœŸ**: 2025-10-30  
**ç‰ˆæœ¬**: v2.0 Final  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

*Luna Badge - è®©æƒ…ç»ªåœ°å›¾æ›´æœ‰ä½“æ„Ÿ*


