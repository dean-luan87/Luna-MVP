# Luna Badge 门牌号识别 × 路线推理系统总结

## 📋 系统概述

实现了门牌号识别与路线推理系统，用于判断当前位置和行进方向是否正确。

## ✅ 核心模块

### D1: doorplate_reader.py（已增强）
**功能**: 识别门牌号、楼层、区域等内容，用于判断当前位置

**核心特性**:
- 识别门牌内容（如"501室"、"B栋"、"Floor 9"）
- 兼容中文、英文、阿拉伯数字等混排格式
- 输出结构化信息
- 支持轻度模糊校正（如玻璃反光）
- 警惕楼层跨越异常（如509 → 805）

**输出格式**:
```json
{
  "event": "doorplate_detected",
  "room_number": "501",
  "area": "东区",
  "floor": "5",
  "bbox": [100, 50, 150, 100],
  "confidence": 0.91,
  "timestamp": "2025-10-28T10:20:00Z",
  "anomaly_detected": false,
  "raw_text": "501室"
}
```

### D2: doorplate_inference.py（已增强）
**功能**: 推理门牌变化趋势，判断方向正确与否

**核心特性**:
- 维护当前与上一识别结果
- 判断门牌号是否在"递增/递减"趋势
- 结合用户目标房号（如510），判断是否靠近
- 检测"跳跃式"门牌号（如501 → 801），标记为异常

**输出格式**:
```json
{
  "event": "doorplate_direction_analysis",
  "trend": "increasing",
  "confidence": 0.85,
  "is_approaching_target": true,
  "recommendation": "continue",
  "last_seen": "501",
  "current_seen": "509",
  "timestamp": "2025-10-28T10:20:00Z"
}
```

## 🔮 扩展模块（预留）

### E1: floorplan_structure_parser.py（预研）
- 识别室内导览图/楼层图
- 自动构建平面结构（如商场电梯旁导览图）
- 生成可视地图骨架供 local_map_generator.py 接入

### E2: home_location_memory.py（预研）
- 记录家人的门牌号/住址信息
- 用于推理"回家路线"或"靠近熟悉区域"
- 与门牌推理模块结合判断偏航情况

### E3: indoor_micro_map.py（预研）
- 在无GPS环境中，构建基于门牌/物体识别的微型地图
- 结合门牌位置、椅子、电梯、扶梯等识别结果
- 生成基于坐标相对值的2D地图

## 🔗 模块联动

| 联动模块 | 说明 |
|---------|------|
| path_evaluator.py | 若门牌方向判断为异常 → 输出"高风险"路径等级 |
| speech_style_manager.py | 偏航时使用"温柔提醒"语气 |
| memory_store.py | 若目标房间号由用户设定 → 判断是否靠近 |
| local_map_generator.py | 将门牌编号标注在地图上 |

## 🎙️ 播报样例

| 场景 | 播报内容 |
|------|---------|
| 门牌递增 | "您正在前进方向，房间号逐步增加" |
| 门牌递减 | "可能方向错误，房间号变小了" |
| 异常跳变 | "房号跳变异常，请确认是否进入了错误区域" |

## ✅ 测试结果

### D1 门牌识别测试
- ✅ 成功识别"501室"
- ✅ 输出结构化信息（room_number, bbox, confidence等）
- ✅ 异常检测功能正常

### D2 门牌推理测试
- ✅ 成功推理501→509递增趋势
- ✅ 建议"continue"继续前进
- ✅ 目标接近判断功能正常

## 🎯 技术特点

1. **多语言支持**: 兼容中文、英文、阿拉伯数字混排
2. **异常检测**: 自动识别楼层跨越等异常情况
3. **趋势分析**: 基于历史数据判断行进方向
4. **目标导向**: 结合用户目标判断是否接近
5. **结构化输出**: 统一的JSON格式便于集成

## 📈 未来扩展

- 集成真实OCR引擎（Tesseract/PaddleOCR）
- 添加更多门牌格式支持
- 实现室内地图自动构建
- 支持语音播报集成

---

**实现日期**: 2025年10月27日  
**版本**: v1.2  
**状态**: ✅ 核心功能测试通过
