# Luna Badge 项目架构总结

## 🎯 项目概述

Luna Badge是一个可在Mac与嵌入式设备(RV1126)上通用的AI控制系统，专为Luna徽章项目设计。系统采用分层架构，通过硬件抽象层实现跨平台兼容。

## 📁 项目结构

```
Luna_Badge/
│
├─ core/                        # 系统核心逻辑层（通用）
│   ├─ __init__.py              # 核心模块初始化
│   ├─ config.py                # 配置管理与加载
│   ├─ system_control.py        # 状态机、自检、错误日志、状态循环
│   ├─ ai_navigation.py         # AI识别模块统一调度
│   └─ hal_interface.py         # 硬件抽象层接口定义
│
├─ hal_mac/                     # Mac 版本硬件驱动层
│   ├─ __init__.py              # Mac硬件模块初始化
│   └─ hardware_mac.py          # 摄像头、麦克风、TTS播报
│
├─ hal_embedded/                # 嵌入式硬件驱动层（RV1126）
│   ├─ __init__.py              # 嵌入式硬件模块初始化
│   └─ hardware_embedded.py     # 摄像头GPIO、电源控制、语音输出
│
├─ config.json                  # 模式与参数配置文件
├─ main_mac.py                  # Mac 运行入口
├─ main_embedded.py             # 嵌入式运行入口
├─ requirements.txt             # 依赖清单
├─ test_structure.py            # 项目结构测试脚本
└─ README.md                    # 项目说明文档
```

## 🏗️ 架构设计

### 1. 分层架构

- **核心逻辑层 (core/)**: 包含所有业务逻辑，与硬件平台无关
- **硬件抽象层 (hal_*/)**: 平台特定的硬件实现
- **配置层 (config.json)**: 统一的配置管理
- **入口层 (main_*.py)**: 平台特定的启动入口

### 2. 硬件抽象层设计

- **统一接口**: 所有硬件组件都实现统一的接口
- **平台适配**: 通过不同的实现类适配不同平台
- **自动检测**: 系统自动检测运行平台并加载相应驱动

### 3. 状态机设计

- **ACTIVE**: 活跃状态，执行AI导航
- **IDLE**: 空闲状态，等待用户指令
- **SLEEP**: 睡眠状态，低功耗模式
- **OFF**: 关闭状态

## 🔧 核心功能

### 1. 配置管理 (config.py)
- 自动平台检测
- 动态配置加载和保存
- 嵌套配置键支持
- 默认配置生成

### 2. 系统控制 (system_control.py)
- 状态机管理
- 系统自检
- 错误日志记录
- 硬件状态监控
- 自动修复机制

### 3. AI导航 (ai_navigation.py)
- 环境检测模块
- 天气故障保护模块
- 指示牌导航模块
- 语音路径理解模块
- 统一调度管理

### 4. 硬件抽象层 (hal_interface.py)
- 摄像头接口
- 麦克风接口
- 扬声器接口
- 网络接口
- AI模型接口
- 硬件管理器

## 🖥️ 平台支持

### Mac平台
- **摄像头**: OpenCV + 系统摄像头
- **麦克风**: PyAudio + 系统麦克风
- **语音识别**: Whisper
- **语音合成**: Edge-TTS / pyttsx3
- **AI模型**: YOLOv8 + Ultralytics

### 嵌入式平台 (RV1126)
- **摄像头**: OpenCV + USB摄像头
- **麦克风**: ALSA + 系统麦克风
- **语音识别**: PicoVoice (预留)
- **语音合成**: espeak / festival
- **AI模型**: RKNN + 优化模型

## 📊 测试结果

项目结构测试已通过：
- ✅ 核心模块导入成功
- ✅ Mac硬件模块导入成功
- ✅ 嵌入式硬件模块导入成功
- ✅ 配置管理功能正常
- ✅ 系统控制功能正常
- ✅ AI导航功能正常
- ✅ 硬件接口创建成功

## 🚀 使用方式

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置系统
编辑 `config.json` 文件设置平台和参数。

### 3. 运行系统

#### Mac平台
```bash
python main_mac.py
```

#### 嵌入式平台
```bash
python main_embedded.py
```

### 4. 测试项目结构
```bash
python test_structure.py
```

## 🎯 架构优势

1. **跨平台兼容**: 通过硬件抽象层实现Mac和嵌入式平台的无缝切换
2. **模块化设计**: 核心逻辑与硬件实现分离，便于维护和扩展
3. **统一接口**: 所有硬件组件都实现统一的接口，便于替换和升级
4. **自动检测**: 系统自动检测运行平台，无需手动配置
5. **配置管理**: 统一的配置管理，支持动态配置和持久化
6. **错误处理**: 完善的错误处理和自动修复机制
7. **状态监控**: 实时监控系统状态和硬件状态

## 📈 扩展性

- **新增平台**: 只需实现硬件抽象层接口
- **新增硬件**: 只需实现相应的硬件接口
- **新增AI模块**: 只需在AI导航模块中添加相应逻辑
- **新增功能**: 只需在核心逻辑层添加相应功能

## 🔮 未来规划

1. **性能优化**: 针对嵌入式平台进行性能优化
2. **功能扩展**: 添加更多AI识别功能
3. **硬件支持**: 支持更多硬件平台
4. **云端集成**: 集成云端AI服务
5. **用户界面**: 添加图形用户界面

## 📝 开发指南

1. **添加新功能**: 在核心逻辑层添加功能
2. **添加新硬件**: 在硬件抽象层添加实现
3. **修改配置**: 在config.json中添加配置项
4. **测试功能**: 使用test_structure.py测试功能

## 🎉 总结

Luna Badge项目架构设计合理，功能完整，具有良好的扩展性和维护性。通过分层架构和硬件抽象层，实现了跨平台兼容，为Luna徽章项目提供了坚实的技术基础。
